<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <title>本地工作台</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script>
    // 强制覆盖 UA 为 Windows 桌面浏览器
    Object.defineProperty(navigator, 'userAgent', {
      get: function () {
        return "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36";
      }
    });
    Object.defineProperty(navigator, 'platform', {
      get: function () {
        return "Win32";
      }
    });
  </script>
  <style>
    /*全局字体*/
    @font-face {
      font-family: 'Chillax';
      src: url('/FONTS/Chillax-Bold.otf') format('opentype');
      font-weight: 800;
      font-style: normal;
      font-display: swap;
    }

    html,
    body,
    * {
      font-family: 'Chillax', Arial, sans-serif !important;
      font-weight: 800;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      position: relative;
    }

    body {
      width: 100vw;
      height: 100vh;
      background: #000;
    }

    #video-wallpaper {
      position: fixed;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      object-position: left top;
      z-index: 0;
      pointer-events: none;
      user-select: none;
      -webkit-user-select: none;
    }

    .taskbar {
      position: fixed;
      left: 0;
      bottom: 0;
      width: 100%;
      height: 56px;
      z-index: 2000;
      display: flex;
      align-items: center;
      padding: 0 12px 0 22px;
      box-sizing: border-box;
      backdrop-filter: blur(12px) saturate(140%);
      -webkit-backdrop-filter: blur(12px) saturate(140%);
      backdrop-filter: blur(12px) saturate(140%);
      color: #fff;
      font-size: 18px;
      letter-spacing: 2px;
      transition: transform 0.4s cubic-bezier(.4, 0, .2, 1), opacity 0.4s;
      will-change: transform, opacity;
    }

    .taskbar-hidden {
      transform: translateY(100%);
      opacity: 0;
      pointer-events: none;
    }

    .gradient-text {
      font-size: 24px;
      background: linear-gradient(90deg,
          #88B1F1,
          #9AF0FD,
          #F0C4E5,
          #C3C2EC,
          #88B1F1);
      background-size: 1000%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: gradient-move 2.5s linear infinite;
      flex-shrink: 0;
      margin-right: 28px;
    }

    @keyframes gradient-move {
      0% {
        background-position: 0% 50%, 0% 50%;
      }

      100% {
        background-position: 100% 50%, 100% 50%;
      }
    }

    .taskbar-center {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      min-width: 0;
    }

    .taskbar-window {
      height: 36px;
      width: 36px;
      padding: 0;
      justify-content: center;
      background: rgb(255 255 255 / 60%);
      /* backdrop-filter: blur(20px); */
      border-radius: 10px;
      display: flex;
      align-items: center;
      /* box-shadow: 0 2px 8px rgba(0, 0, 0, 0.07); */
      cursor: pointer;
      font-size: 14px;
      color: #333;
      border: 1px solid #ddd;
      transition: background 0.3s;
      z-index: 1200;
      margin: 0 8px;
      /* 两侧间距8px，可根据需要调整 */
    }

    .taskbar-window:hover {
      background: #f5f5f7;
    }

    .date-info {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      line-height: 1.2;
      font-size: 16px;
      white-space: pre-line;
      min-width: 110px;
      flex-shrink: 0;
      margin-left: 28px;
    }

    #date-main {
      font-weight: 700;
    }

    #date-sub {
      font-size: 13px;
      color: #bbb;
    }

    .window {
      width: 400px;
      height: 340px;
      background: rgba(24, 26, 32, 0.459);
      backdrop-filter: blur(20px);
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.18);
      border-radius: 16px;
      position: absolute;
      top: 120px;
      left: 100px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: width 0.2s, height 0.2s, top 0.2s, left 0.2s;
      z-index: 1000;
      min-width: 240px;
      min-height: 120px;
      border: none;
    }

    .window.maximized {
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      border-radius: 0 !important;
    }

    .hidden {
      display: none !important;
    }

    .title-bar {
      height: 42px;
      /* background: rgba(24, 26, 32, 0.459); */
      display: flex;
      align-items: center;
      justify-content: space-between;
      backdrop-filter: blur(20px);
      padding: 0 0px 0 18px;
      /* border-bottom: 1px solid #23242a; */
      font-weight: 800;
      font-size: 20px;
      color: #fff;
      border-radius: 12px 12px 0 0;
      user-select: none;
      position: relative;
      letter-spacing: 1px;

    }

    .window.maximized .title-bar {
      border-radius: 0 !important;
    }

    .mac-btns {
      display: flex;
      gap: 2px;
      margin-right: 12px;
      align-items: center;
      background: none;
      border: none;
      box-shadow: none;
      padding: 0;
    }

    .mac-btn {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: none;
      margin: 0;
      transition: background 0.15s;
      font-size: 18px;
      background: none;
      box-shadow: none;
    }

    .mac-btn.red {
      color: #ff5f57;
    }

    .mac-btn.yellow {
      color: #ffbd2e;
    }

    .mac-btn.green {
      color: #28c940;
    }

    .mac-btn::before {
      content: '';
      display: block;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: currentColor;
      opacity: 0.95;
    }

    .mac-btn:hover::before {
      opacity: 1;
      filter: brightness(1.2);
    }

    .window-content {
      display: flex;
      flex-direction: column;
      gap: 18px;
      flex: 1;
      color: #fff;
      font-size: 16px;
      background: none;
    }

    .btn {
      padding: 8px 18px;
      border: none;
      background: #3a7afe;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 800;
      transition: background 0.2s;
      margin-right: 10px;
      box-shadow: 0 2px 8px rgba(58, 122, 254, 0.08);
    }

    .btn:hover {
      background: #2556b8;
    }

    .counter-value {
      font-size: 18px;
      font-weight: bold;
      color: #fff;
      margin-right: 8px;
    }

    .snap-hint {
      position: fixed;
      pointer-events: none;
      z-index: 3000;
      border: 2px dashed #89f;
      background: rgba(136, 177, 241, 0.12);
      border-radius: 8px;
      transition: all 0.2s;
      opacity: 0.92 !important;
      border: 3px solid #4e8cff;
      box-shadow: 0 0 24px #4e8cff66;
      transition: opacity 0.18s, box-shadow 0.18s;
    }

    .snap-hint.left {
      left: 0;
      top: 0;
      width: 50vw;
      height: 100vh;
    }

    .snap-hint.right {
      left: 50vw;
      top: 0;
      width: 50vw;
      height: 100vh;
    }

    .snap-hint.top {
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
    }

    .snap-hint.topleft {
      left: 0;
      top: 0;
      width: 50vw;
      height: 50vh;
    }

    .snap-hint.topright {
      left: 50vw;
      top: 0;
      width: 50vw;
      height: 50vh;
    }

    .snap-hint.bottomleft {
      left: 0;
      top: 50vh;
      width: 50vw;
      height: 50vh;
    }

    .snap-hint.bottomright {
      left: 50vw;
      top: 50vh;
      width: 50vw;
      height: 50vh;
    }

    #intro-video {
      position: fixed;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      z-index: 9999;
      background: #000;
      display: block;
      transition: opacity 0.8s;
    }

    #skip-btn {
      position: fixed;
      right: 40px;
      top: 40px;
      z-index: 10000;
      padding: 8px 18px;
      background: rgba(0, 0, 0, 0.55);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: background .2s, opacity 0.8s;
      display: block;
    }

    #skip-btn:hover {
      background: #ffd369;
      color: #222;
    }

    @keyframes minimize-to-taskbar {
      0% {
        opacity: 1;
        transform: scale(1) rotate(0) skew(0, 0) translate(0, 0);
        filter: blur(0);
      }

      60% {
        transform: scale(0.4, 0.6) rotate(-8deg) skew(0, 12deg) translate(0, 0);
        filter: blur(1px);
        opacity: 0.8;
      }

      80% {
        transform: scale(0.2, 0.6) rotate(10deg) skew(0, 30deg) translate(0, 0);
        filter: blur(2px);
        opacity: 0.5;
      }

      /* 100% 由js动态生成 */
    }

    .window.minimizing {
      pointer-events: none;
      will-change: transform, opacity, filter;
      animation: minimize-to-taskbar 0.48s cubic-bezier(.6, -0.2, .9, 1.4) forwards;
      z-index: 3000 !important;
    }

    /* 新增：桌面快捷方式样式 */
    .desktop-area {
      position: fixed;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      z-index: 10;
      pointer-events: none;
    }

    .desktop-shortcut {
      position: absolute;
      top: 32px;
      left: 20px;
      width: 80px;
      height: 80px;
      bottom: 20px;
      text-align: center;
      pointer-events: auto;
      cursor: pointer;
      user-select: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .desktop-shortcut img {
      width: 48px;
      height: 48px;
    }

    .desktop-shortcut span {
      display: block;
      color: #fff;
      font-size: 14px;
      /*margin-top: 6px;*/
    }

    /* 启动台样式 */
    .launchpad-btn {
      background: none;
      border: none;
      margin-right: 18px;
      cursor: pointer;
      outline: none;
      padding: 0;
      transition: filter 0.2s;
      z-index: 2100;
    }

    .launchpad-btn:hover {
      filter: brightness(1.4);
    }

    .launchpad-overlay {
      position: fixed;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background: rgb(255 255 255 / 12%);
      z-index: 4000;
      display: flex;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(18px) saturate(140%);
      opacity: 0;
      pointer-events: none;
      transform: scale(1.08);
      transition: opacity 0.38s cubic-bezier(.4, 0, .2, 1), transform 0.38s cubic-bezier(.4, 0, .2, 1);
    }

    .launchpad-overlay.active {
      opacity: 1;
      pointer-events: auto;
      transform: scale(1);
    }

    .launchpad-content {
      display: flex;
      flex-wrap: wrap;
      gap: 48px;
      justify-content: center;
      align-items: center;
      width: 700px;
      max-width: 90vw;
      min-height: 340px;
      transition: transform 0.3s cubic-bezier(.4, 0, .2, 1);
    }

    .launchpad-app {
      width: 100px;
      text-align: center;
      cursor: pointer;
      user-select: none;
      transition: transform 0.18s cubic-bezier(.4, 0, .2, 1);
      will-change: transform;
      animation: app-bounce-in 0.5s;
    }

    @keyframes app-bounce-in {
      0% {
        transform: scale(0.7) translateY(40px);
        opacity: 0;
      }

      60% {
        transform: scale(1.12) translateY(-10px);
        opacity: 1;
      }

      100% {
        transform: scale(1) translateY(0);
      }
    }

    .launchpad-app img {
      width: 64px;
      height: 64px;
    }

    .launchpad-app span {
      color: #fff;
      display: block;
      margin-top: 10px;
      font-size: 17px;
    }

    .launchpad-app:hover {
      transform: scale(1.08);
    }

    .launchpad-pagination {
      position: absolute;
      bottom: 60px;
      left: 0;
      width: 100vw;
      display: flex;
      justify-content: center;
      gap: 12px;
      z-index: 4100;
    }

    .launchpad-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #fff5;
      transition: background 0.2s;
      cursor: pointer;
    }

    .launchpad-dot.active {
      background: #fff;
    }

    @media (max-width: 800px) {
      .launchpad-content {
        width: 98vw;
        gap: 24px;
      }
    }

    /* ==== 窗口拉伸手柄样式 ==== */
    .resize-handle {
      position: absolute;
      z-index: 10;
      background: transparent;
    }

    .resize-handle-n,
    .resize-handle-s {
      left: 0;
      right: 0;
      height: 8px;
      cursor: ns-resize;
    }

    .resize-handle-n {
      top: -4px;
    }

    .resize-handle-s {
      bottom: -4px;
    }

    .resize-handle-e,
    .resize-handle-w {
      top: 0;
      bottom: 0;
      width: 8px;
      cursor: ew-resize;
    }

    .resize-handle-e {
      right: -4px;
    }

    .resize-handle-w {
      left: -4px;
    }

    .resize-handle-nw,
    .resize-handle-ne,
    .resize-handle-sw,
    .resize-handle-se {
      width: 12px;
      height: 12px;
      z-index: 11;
    }

    .resize-handle-nw {
      left: -6px;
      top: -6px;
      cursor: nwse-resize;
    }

    .resize-handle-ne {
      right: -6px;
      top: -6px;
      cursor: nesw-resize;
    }

    .resize-handle-sw {
      left: -6px;
      bottom: -6px;
      cursor: nesw-resize;
    }

    .resize-handle-se {
      right: -6px;
      bottom: -6px;
      cursor: nwse-resize;
    }

    .show-desktop-btn {
      margin-left: 18px;
      width: 10px;
      height: 38px;
      border-radius: 12px;
      background: rgba(200, 210, 255, 0.22);
      border: none;
      cursor: pointer;
      transition: background 0.18s, box-shadow 0.18s;
      box-shadow: 0 2px 8px rgba(136, 177, 241, 0.08);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .show-desktop-btn:hover {
      background: #e6f0ff;
      box-shadow: 0 4px 16px #88b1f133;
    }

    /* 新增：启动台搜索框样式 */
    .launchpad-search-bar {
      position: absolute;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      width: 420px;
      max-width: 90vw;
      display: flex;
      align-items: center;
      z-index: 4200;
      background: rgba(30, 32, 38, 0.92);
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(136, 177, 241, 0.10);
      padding: 0 6px 0 6px;
      height: 48px;
      border: 3px solid transparent;
      background-clip: padding-box, border-box;
      background-origin: padding-box, border-box;
      background-image: linear-gradient(rgba(30, 32, 38, 0.92), rgba(30, 32, 38, 0.92)),
        linear-gradient(90deg, #88B1F1, #9AF0FD, #F0C4E5, #F9F871, #F0C4E5, #88B1F1);
      animation: gradient-move 2.5s linear infinite;
      background-size: 1000% 1000%;
      background-position: 0% 50%, 0% 50%;
    }

    .launchpad-search-bar:focus-within {
      box-shadow: 0 6px 32px #88b1f144;
      border-color: #9AF0FD;
    }

    #launchpad-search-input {
      flex: auto;
      height: 38px;
      border: none;
      outline: none;
      background: transparent;
      color: #fff;
      /* font-size: 18px; */
      font-family: 'Chillax', Arial, sans-serif;
      font-weight: 800;
      letter-spacing: 1px;
      /* padding: 0 8px; */
    }

    #launchpad-search-input::placeholder {
      color: #bcd;
      opacity: 0.85;
      font-weight: 400;
    }

    #launchpad-search-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0 6px;
      display: flex;
      align-items: center;
      transition: filter 0.18s;
    }

    #launchpad-search-btn:hover svg {
      filter: brightness(1.3) drop-shadow(0 2px 8px #88b1f133);
    }

    @media (max-width: 600px) {
      .launchpad-search-bar {
        width: 98vw;
        min-width: 0;
        padding: 0 6px 0 10px;
      }

      #launchpad-search-input {
        font-size: 16px;
      }
    }

    #flyme-linkpc .window-content {
      padding: 0;
      margin: 0;
      width: 100%;
      height: 100%;
      box-sizing: border-box;
      display: flex;
    }

    #flyme-linkpc .window-content iframe {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
      box-sizing: border-box;
      background: #fff;
      border-radius: 0;
      min-width: 0;
      min-height: 0;
      max-width: 100%;
      max-height: 100%;
      overflow: hidden;
    }

    /* snap分屏按钮样式 */
    .snap-top-options {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 80px;
      z-index: 5000;
      pointer-events: none;
    }

    .snap-top-btn {
      position: absolute;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s, transform 0.2s;
      pointer-events: auto;
    }

    .snap-top-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .snap-top-btn:active {
      transform: scale(0.95);
    }

    .snap-full {
      top: 10px;
      left: calc(50% - 30px);
    }

    .snap-left {
      top: 10px;
      left: calc(10px);
    }

    .snap-right {
      top: 10px;
      right: calc(10px);
    }

    .snap-topleft {
      top: 10px;
      left: calc(10px);
    }

    .snap-topright {
      top: 10px;
      right: calc(10px);
    }

    .snap-bottomleft {
      bottom: 10px;
      left: calc(10px);
    }

    .snap-bottomright {
      bottom: 10px;
      right: calc(10px);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background-color: #f4f4f4;
      /* 让内容居中显示 */
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      font-family: Arial, sans-serif;
    }

    /* 窗口容器样式 */
    .window-container {
      position: relative;
      width: 900px;
      height: 510px;
      background: url('your-image.jpg') no-repeat center center / cover;
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      z-index: 1000;
    }

    /* 关闭按钮样式，定位在右上角 */
    .close-btn {
      position: absolute;
      display: flex;
      top: 30.5px;
      right: 26px;
      width: 30px;
      height: 30px;
      cursor: pointer;
      font-size: 45px;
      color: #fff;
      text-align: center;
      line-height: 30px;
      border-radius: 50%;
    }

    /* 标题样式，左上角显示 */
    .title {
      position: absolute;
      display: flex;
      top: 25px;
      left: 26px;
      font-size: 28px;
      color: #fff;
      font-weight: bold;
    }

    /* 底部导航栏样式 */
    .bottom-nav {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 80px;
      background-color: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(20px);
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: 0 20px;
      z-index: 1001;
    }

    .nav-btns {
      display: flex;
      gap: 14px;
    }

    .nav-btn {
      width: 100px;
      height: 44px;
      border-radius: 12px;
      background-color: rgb(255 255 255 / 0%);
      backdrop-filter: blur(20px);
      border: none;
      cursor: pointer;
      font-size: 20px;
      color: #ffffff;
    }

    .start-btn {
      height: 56px;
      width: 190px;
      border: none;
      color: #fff;
      border-radius: 29px;
      background-color: rgb(255 255 255 / 0%);
      backdrop-filter: blur(20px);
      cursor: pointer;
      font-size: 20px;
      margin-left: auto;
    }

    /* 个人信息样式，右下角位置 */
    .creator {
      position: absolute;
      bottom: 100px;
      right: 6px;
      display: flex;
      align-items: center;
      gap: 5px;
      color: #fff;
      justify-content: right;
      /* width: 200px; */
    }

    .creator img {
      width: 36px;
      height: 36px;
      border-radius: 8px;
    }

    .creator span {
      max-width: 160px;
      width: auto;
      padding: 0 26px 0 0;
      display: inline-block;
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
      text-align: right;
    }

    /* 拉伸手柄样式 */
    .resize-handle {
      position: absolute;
      width: 16px;
      height: 16px;
      /*background: rgba(255, 255, 255, 0.7); 是否显示拉伸区域*/
      border-radius: 50%;
      z-index: 1010;
      cursor: pointer;
    }

    .resize-handle.nw {
      top: -8px;
      left: -8px;
      cursor: nwse-resize;
    }

    .resize-handle.ne {
      top: -8px;
      right: -8px;
      cursor: nesw-resize;
    }

    .resize-handle.sw {
      bottom: -8px;
      left: -8px;
      cursor: nesw-resize;
    }

    .resize-handle.se {
      bottom: -8px;
      right: -8px;
      cursor: nwse-resize;
    }

    .resize-handle.n {
      width: 80%;
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
      cursor: ns-resize;
    }

    .resize-handle.s {
      width: 80%;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      cursor: ns-resize;
    }

    .resize-handle.e {
      height: 80%;
      right: -8px;
      top: 50%;
      transform: translateY(-50%);
      cursor: ew-resize;
    }

    .resize-handle.w {
      height: 80%;
      left: -8px;
      top: 50%;
      transform: translateY(-50%);
      cursor: ew-resize;
    }

    /* 圆角矩形样式 */
    .rounded-rect {
      position: absolute;
      top: 80px;
      left: 80px;
      min-width: 120px;
      max-width: 400px;
      height: auto;
      min-height: 60px;
      padding: 18px 24px;
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      z-index: 2;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: width 0.3s, font-size 0.3s;
      word-break: break-all;
      overflow-wrap: break-word;
    }

    .hitokoto-text {
      font-size: 22px;
      color: #333;
      text-align: center;
      word-break: break-all;
      line-height: 1.4;
      transition: font-size 0.3s;
      width: 100%;
      display: block;
      max-width: 100%;
      white-space: pre-line;
    }

    /* 城市选择弹窗样式 */
    #city-modal {
      display: none;
      position: fixed;
      z-index: 9999;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.18);
      align-items: center;
      justify-content: center;
    }

    #city-modal>div {
      background: rgba(255, 255, 255, 0.55);
      backdrop-filter: blur(18px);
      border-radius: 24px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.10);
      padding: 36px 32px 28px 32px;
      min-width: 320px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }

    #city-modal button {
      /* position: absolute; */
      top: 18px;
      right: 22px;
      font-size: 28px;
      background: none;
      border: none;
      color: #888;
      cursor: pointer;
      transition: color 0.2s;
    }

    #city-modal button:hover {
      color: #333;
    }

    #city-modal select {
      font-size: 20px;
      padding: 10px 18px;
      border-radius: 12px;
      border: 1px solid #e0e0e0;
      width: 220px;
      background: rgba(255, 255, 255, 0.7);
      margin-bottom: 22px;
      outline: none;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      color: #333;
    }

    #city-modal #city-save-btn {
      font-size: 20px;
      padding: 8px 38px;
      border-radius: 14px;
      border: none;
      background: linear-gradient(90deg, #4e8cff 0%, #6ad1ff 100%);
      color: #fff;
      font-weight: bold;
      letter-spacing: 2px;
      box-shadow: 0 2px 8px rgba(78, 140, 255, 0.08);
      cursor: pointer;
      transition: background 0.2s;
    }

    #city-modal #city-save-btn:hover {
      background: linear-gradient(90deg, #6ad1ff 0%, #4e8cff 100%);
    }

    /* 汉堡菜单样式 */
    .hamburger-menu {
      position: absolute;
      top: 60px;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgb(0 0 0 / 22%);
      border-radius: 24px 24px 0 0;
      box-shadow: 0 -30px 12px rgba(0, 0, 0, 0.12);
      z-index: 99;
      backdrop-filter: blur(20px);
      padding: 0 0 24px 0;
      animation: fadeIn .2s;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .menu-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 18px 32px 8px 32px;
      font-size: 22px;
      font-weight: bold;
      color: #222;
    }

    .menu-close {
      font-size: 28px;
      background: none;
      border: none;
      color: #888;
      cursor: pointer;
    }

    .menu-list {
      display: flex;
      flex-wrap: wrap;
      gap: 18px;
      padding: 0 32px;
    }

    .game-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: rgba(78, 140, 255, 0.08);
      border-radius: 18px;
      width: 90px;
      padding: 12px 0;
    }

    .game-icon {
      width: 48px;
      height: 48px;
      background: #eee;
      border-radius: 12px;
      margin-bottom: 8px;
    }

    .game-name {
      font-size: 16px;
      color: #333;
    }

    .message-layout {
      display: flex;
      height: 220px;
      margin: 0 32px;
    }

    .contacts {
      width: 90px;
      border-right: 1px solid #eee;
      padding: 8px 0;
    }

    .contact {
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 8px;
      margin-bottom: 6px;
    }

    .contact.active,
    .contact:hover {
      background: #e6f0ff;
      color: #4e8cff;
    }

    .chat-window {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 8px 0 0 18px;
    }

    .chat-history {
      flex: 1;
      overflow-y: auto;
      background: #f7f7fa;
      border-radius: 8px;
      margin-bottom: 8px;
      padding: 8px;
      font-size: 15px;
    }

    .chat-input {
      width: 70%;
      padding: 6px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    .chat-send {
      padding: 6px 18px;
      border-radius: 8px;
      background: #4e8cff;
      color: #fff;
      border: none;
      margin-left: 8px;
    }

    #menu-account input[type="text"] {
      margin-top: 8px;
      width: 70%;
      padding: 6px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    #menu-account button {
      margin-top: 16px;
      width: 100%;
      padding: 8px;
      border-radius: 12px;
      background: #4e8cff;
      color: #fff;
      border: none;
    }

    .chart-block {
      margin-bottom: 18px;
    }

    .chart-title {
      font-size: 15px;
      color: #333;
      margin-bottom: 2px;
    }

    body {
      height: 100vh;
      margin: 0;
      background: #f5f5f5;
    }

    .context-menu {
      position: absolute;
      top: 0;
      left: 0;
      min-width: 150px;
      background: #ffffff59;
      backdrop-filter: blur(20px);
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      opacity: 0;
      pointer-events: none;
      transform: scale(0.95);
      transition: opacity 0.2s cubic-bezier(.4, 0, .2, 1), transform 0.2s cubic-bezier(.4, 0, .2, 1);
      z-index: 10000;
    }

    .context-menu.show {
      opacity: 1;
      pointer-events: auto;
      transform: scale(1);
    }

    .context-menu ul {
      list-style: none;
      margin: 0;
      padding: 8px 0;
    }

    .context-menu li {
      padding: 10px 24px;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      color: #474747;
      align-items: center;
    }

    .context-menu li:hover {
      background: #f0f0f0;
    }

    .tz-notification {
      position: relative;
      min-width: 320px;
      max-width: 360px;
      background: #ffffff3d;
      border-radius: 18px;
      backdrop-filter: blur(20px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.18);
      display: flex;
      align-items: flex-start;
      padding: 20px 24px 20px 20px;
      z-index: 99999;
      animation: tz-fade-in 0.4s;
      pointer-events: auto;
      animation: tz-fade-in 0.4s, tz-pop-in 0.38s cubic-bezier(.4, 0, .2, 1);
      transform: perspective(600px) translateZ(0) scale(1) rotateY(0deg);
      transition:
        box-shadow 0.2s,
        transform 0.28s cubic-bezier(.4, 0, .2, 1),
        opacity 0.28s cubic-bezier(.4, 0, .2, 1);
    }

    @keyframes tz-pop-in {
      0% {
        opacity: 0;
        transform: perspective(600px) scale(0.7) rotateY(-25deg) translateY(40px);
      }

      60% {
        opacity: 1;
        transform: perspective(600px) scale(1.08) rotateY(8deg) translateY(-8px);
      }

      100% {
        opacity: 1;
        transform: perspective(600px) scale(1) rotateY(0deg) translateY(0);
      }
    }


    .tz-notification.tz-leave {
      animation: tz-pop-out 0.38s cubic-bezier(.4, 0, .2, 1) forwards;
      pointer-events: none;
    }

    .tz-notification:hover {
      box-shadow: 0 12px 48px #4e8cff44, 0 2px 8px #0002;
      transform: perspective(600px) scale(1.04) rotateY(-10deg) translateY(-2px);
      z-index: 100000;
    }

    .tz-notification-icon {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      background: linear-gradient(135deg, #ffffff 60%, #5effbf 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 16px;
      color: #fff;
      font-size: 20px;
      flex-shrink: 0;
    }

    .tz-notification-content {
      flex: 1;
      min-width: 0;
    }

    .tz-notification-title {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #222;
    }

    .tz-notification-message {
      font-size: 15px;
      color: #555;
      word-break: break-all;
    }

    .tz-notification-close {
      background: none;
      border: none;
      font-size: 18px;
      color: #aaa;
      cursor: pointer;
      margin-left: 12px;
      margin-top: 2px;
      transition: color 0.2s;
      align-self: flex-start;
    }

    .tz-notification-close:hover {
      color: #4f8cff;
    }

    .tz-notification-image {
      width: 100%;
      max-height: 120px;
      object-fit: cover;
      border-radius: 10px;
      margin-bottom: 8px;
      margin-top: 4px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .tz-notification-container {
      position: fixed;
      top: 32px;
      right: 32px;
      z-index: 99999;
      display: flex;
      flex-direction: column;
      gap: 18px;
      pointer-events: none;
    }

    .tz-notification-actions {
      margin-top: 10px;
      display: flex;
      gap: 10px;
    }

    .tz-notification-action {
      background: #4f8cff;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 6px 18px;
      font-size: 15px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .tz-notification-action:hover {
      background: #2563eb;
    }

    .search-engine-select {
      position: relative;
      margin-right: 8px;
    }

    #search-engine-btn {
      display: flex;
      align-items: center;
      background: rgba(255, 255, 255, 0.10);
      border: none;
      border-radius: 10px;
      padding: 4px 10px 4px 6px;
      cursor: pointer;
      font-size: 15px;
      color: #fff;
      transition: background 0.18s;
      backdrop-filter: blur(10px) saturate(120%);
      outline: none;
      margin-right: 2px;
    }

    #search-engine-btn:hover {
      background: rgba(255, 255, 255, 0.22);
    }

    #search-engine-btn img {
      margin-right: 5px;
      border-radius: 4px;
    }

    .search-engine-list {
      display: none;
      position: absolute;
      left: 0;
      top: 38px;
      min-width: 120px;
      background: rgba(30, 32, 38, 0.92);
      border-radius: 14px;
      box-shadow: 0 8px 32px rgba(136, 177, 241, 0.13);
      backdrop-filter: blur(18px) saturate(140%);
      z-index: 9999;
      padding: 6px 0;
      animation: fadeIn .22s;
    }

    .search-engine-list div {
      display: flex;
      align-items: center;
      padding: 7px 18px 7px 12px;
      cursor: pointer;
      color: #fff;
      font-size: 15px;
      transition: background 0.18s, color 0.18s;
    }

    .search-engine-list div:hover {
      background: #4e8cff22;
      color: #88B1F1;
    }

    .search-engine-list img {
      width: 18px;
      height: 18px;
      margin-right: 8px;
      border-radius: 4px;
      background: #fff2;
    }

    #menu-account.hamburger-menu,
    #menu-game.hamburger-menu,
    #menu-dashboard.hamburger-menu,
    #menu-message.hamburger-menu {
      overflow-y: auto;
      max-height: 90%;
      padding-bottom: 70px;
      /* 给底部菜单栏预留空间，避免内容被tab遮挡 */
      /* 美化滚动条 */
      scrollbar-width: thin;
      scrollbar-color: #4e8cff #ffffff22;
    }

    #menu-account.hamburger-menu::-webkit-scrollbar,
    #menu-game.hamburger-menu::-webkit-scrollbar,
    #menu-dashboard.hamburger-menu::-webkit-scrollbar,
    #menu-message.hamburger-menu::-webkit-scrollbar {
      width: 8px;
      background: #ffffff22;
    }

    #menu-account.hamburger-menu::-webkit-scrollbar-thumb,
    #menu-game.hamburger-menu::-webkit-scrollbar-thumb,
    #menu-dashboard.hamburger-menu::-webkit-scrollbar-thumb,
    #menu-message.hamburger-menu::-webkit-scrollbar-thumb {
      background: #4e8cff;
      border-radius: 8px;
    }

    /* 折叠菜单弹窗优化样式 */
    #collapse-modal {
      position: fixed;
      z-index: 9999;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      display: none;
    }

    #collapse-modal .collapse-modal-mask {
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #collapse-modal .collapse-modal-content {
      min-width: 220px;
      background: rgba(255, 255, 255, 0.55);
      border-radius: 24px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.10);
      padding: 36px 32px 28px 32px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }

    #collapse-modal-list button.nav-btn {
      width: 180px;
      height: 44px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.85);
      border: none;
      cursor: pointer;
      font-size: 20px;
      color: #333;
      margin: 0 auto;
      margin-bottom: 8px;
      transition: background 0.18s;
    }

    #collapse-modal-list button.nav-btn:hover {
      background: #e6f0ff;
      color: #4e8cff;
    }
  </style>
</head>
<!-- 启动引导视频及跳过按钮 -->
<video id="intro-video" src="./VF/kjgm.mp4" autoplay muted playsinline></video>
<button id="skip-btn">跳过</button>

<div class="tz-notification-container" id="tzNotificationContainer" style="z-index:99999;"></div>

<div id="main-content" style="display:none;">
  <video id="video-wallpaper" autoplay loop muted playsinline></video>
  <!-- 桌面快捷方式 -->
  <div id="desktop" class="desktop-area">
    <div class="desktop-shortcut" data-app="macWindow">
      <img src="./PIC/Mac.png" alt="窗口" />
      <span>Mac窗口</span>
    </div>
    <div class="desktop-shortcut" data-app="flyme-linkpc">
      <img src="./PIC/flymelink.svg" alt="Flyme 互联" />
      <span>Flyme 互联</span>
    </div>
    <div class="desktop-shortcut" data-app="windowBox">
      <img src="./PIC/windowBox.svg" alt="超级盒子" id="showWindowBox" style="cursor:pointer;" />
      <span>超级盒子</span>
    </div>
    <div class="desktop-shortcut" data-app="sudokuBox">
      <img src="./PIC/Sudoku.png" alt="数独" />
      <span>数独游戏</span>
    </div>
    <div class="desktop-shortcut" data-app="fanbook">
      <img src="./PIC/fanbook.png" alt="Fanbook" />
      <span>Fanbook</span>
    </div>
  </div>
  <!-- 任务栏 -->
  <div class="taskbar" id="taskbar">
    <span class="gradient-text" id="starPlus">STAR+</span>
    <div class="taskbar-center"></div>
    <div class="date-info">
      <div id="date-main"></div>
      <div id="date-sub"></div>
    </div>
    <button id="show-desktop-btn" class="show-desktop-btn" title="显示桌面"></button>
  </div>
  <!-- 启动台界面 -->
  <div id="launchpad" class="launchpad-overlay hidden">
    <!-- 新增：启动台搜索框 -->
    <div class="launchpad-search-bar">
      <div class="search-engine-select">
        <button id="search-engine-btn" title="选择搜索引擎">
          <img id="search-engine-icon" src="https://www.bing.com/favicon.ico" alt="Bing"
            style="width:20px;height:20px;">
          <span id="search-engine-name">Bing</span>
          <svg width="14" height="14" style="margin-left:2px;" viewBox="0 0 14 14">
            <path d="M3 5l4 4 4-4" stroke="#bcd" stroke-width="2" fill="none" stroke-linecap="round" />
          </svg>
        </button>
        <div id="search-engine-list" class="search-engine-list">
          <div data-engine="bing" data-url="https://www.bing.com/search?q="
            data-icon="https://www.bing.com/favicon.ico">
            <img src="https://www.bing.com/favicon.ico" alt="Bing"> Bing
          </div>
          <div data-engine="baidu" data-url="https://www.baidu.com/s?wd=" data-icon="https://www.baidu.com/favicon.ico">
            <img src="https://www.baidu.com/favicon.ico" alt="Baidu"> 百度
          </div>
          <div data-engine="google" data-url="https://www.google.com/search?q=" data-icon="./PIC/google.ico">
            <img src="./PIC/google.ico" alt="Google"> Google
          </div>
          <div data-engine="duckduckgo" data-url="https://duckduckgo.com/?q=" data-icon="./PIC/DuckDuckGo.svg">
            <img src="./PIC/DuckDuckGo.svg" alt="DuckDuckGo"> DuckDuckGo
          </div>
        </div>
      </div>
      <input id="launchpad-search-input" type="text" placeholder="搜索应用或网页..." autocomplete="off" />
      <button id="launchpad-search-btn" title="搜索">
        <svg width="22" height="22" viewBox="0 0 22 22" fill="none">
          <circle cx="10" cy="10" r="8" stroke="#88B1F1" stroke-width="2" />
          <line x1="16.071" y1="16.485" x2="20" y2="20" stroke="#88B1F1" stroke-width="2" stroke-linecap="round" />
        </svg>
      </button>
    </div>

    <div class="launchpad-content"></div>
  </div>
  <!-- Mac风格窗口 -->
  <div class="window hidden" id="macWindow">
    <div class="resize-handle nw"></div> <!--方向 西北-->
    <div class="resize-handle ne"></div> <!--方向 东北-->
    <!--<div class="resize-handle sw"></div> 方向 西南-->
    <div class="resize-handle se"></div> <!--方向 东南-->
    <div class="resize-handle n"></div> <!--方向 北-->
    <div class="resize-handle s"></div> <!--方向 南-->
    <div class="resize-handle e"></div> <!--方向 东-->
    <div class="resize-handle w"></div> <!--方向 西-->
    <div class="title-bar">
      <span class="title"
        style="position: static;font-size: 16px;user-select: none;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;cursor: move;">Mac风格窗口</span>
      <span class="mac-btns">
        <span class="mac-btn red" title="关闭"></span>
        <span class="mac-btn yellow" title="最大化/还原"></span>
        <span class="mac-btn green" title="最小化到任务栏"></span>
      </span>
    </div>
    <div class="window-content">
      <button class="btn" id="helloBtn">你好</button>
      <div>
        <span class="counter-value" id="counter">0</span>
        <button class="btn" id="incBtn">计数器+1</button>
      </div>
      <button class="btn" id="alertBtn">弹窗</button>
    </div>
  </div>
  <!-- Flyme互联窗口 -->
  <div class="window hidden" id="flyme-linkpc" style="width: 344px; height: 570px;">
    <div class="resize-handle nw"></div> <!--方向 西北-->
    <div class="resize-handle ne"></div> <!--方向 东北-->
    <!--<div class="resize-handle sw"></div> 方向 西南-->
    <div class="resize-handle se"></div> <!--方向 东南-->
    <div class="resize-handle n"></div> <!--方向 北-->
    <div class="resize-handle s"></div> <!--方向 南-->
    <div class="resize-handle e"></div> <!--方向 东-->
    <div class="resize-handle w"></div> <!--方向 西-->
    <div class="title-bar">
      <span class="title"
        style="position: static;font-size: 16px;user-select: none;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;cursor: move;">Flyme
        互联</span>
      <span class="mac-btns">
        <span class="mac-btn red" title="关闭"></span>
        <span class="mac-btn yellow" title="最大化/还原"></span>
        <span class="mac-btn green" title="最小化到任务栏"></span>
      </span>
    </div>
    <div class="window-content">
      <iframe src="https://linkpc.flyme.com/" style="width:100%;height:100%;border:none;"></iframe>
    </div>
  </div>

</div>

<div id="snap-top-options"
  style="display:none;position:fixed;top:0;left:0;width:100vw;height:80px;z-index:5000;pointer-events:none;">
  <div class="snap-top-btn snap-full" data-snap="top" title="全屏"></div>
  <div class="snap-top-btn snap-left" data-snap="left" title="左半屏"></div>
  <div class="snap-top-btn snap-right" data-snap="right" title="右半屏"></div>
  <div class="snap-top-btn snap-topleft" data-snap="topleft" title="左上"></div>
  <div class="snap-top-btn snap-topright" data-snap="topright" title="右上"></div>
  <div class="snap-top-btn snap-bottomleft" data-snap="bottomleft" title="左下"></div>
  <div class="snap-top-btn snap-bottomright" data-snap="bottomright" title="右下"></div>
</div>

<body>
  <div class="window-container" id="windowBox" style="z-index:3001;display:none;">
    <div class="resize-handle nw"></div> <!--方向 西北-->
    <div class="resize-handle ne"></div> <!--方向 东北-->
    <!--<div class="resize-handle sw"></div> 方向 西南-->
    <div class="resize-handle se"></div> <!--方向 东南-->
    <div class="resize-handle n"></div> <!--方向 北-->
    <div class="resize-handle s"></div> <!--方向 南-->
    <div class="resize-handle e"></div> <!--方向 东-->
    <div class="resize-handle w"></div> <!--方向 西-->
    <!-- 新增圆角矩形div -->
    <div class="rounded-rect" id="random-component">
      <span id="hitokoto" class="hitokoto-text">加载中...</span>
    </div>
    <!-- 新增圆角矩形div：天气 -->
    <div class="rounded-rect" id="weather-component" style="visibility:hidden;">
      <span id="weather-text" class="hitokoto-text">加载中...</span>
    </div>
    <div class="close-btn">×</div>
    <div class="title"
      style="user-select: none;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;cursor: move;">
      SHOOTING STAR</div>
    <img src="./PIC/cjbox.jpg" style="width:100%;height:100%;pointer-events:none;">
    <div class="bottom-nav">
      <div class="nav-btns">
        <button class="nav-btn">首页</button>
        <button class="nav-btn">游戏列表</button>
        <button class="nav-btn">仪表盘</button>
        <button class="nav-btn">消息</button>
        <button class="nav-btn">账户</button>
      </div>
      <button class="start-btn">开始 Start</button>
    </div>
    <!-- 游戏列表汉堡菜单 -->
    <div id="menu-game" class="hamburger-menu" style="display:none;">
      <div class="menu-header">
        <span>游戏列表</span>
        <button class="menu-close">×</button>
      </div>
      <input type="text" id="game-search" placeholder="搜索游戏..."
        style="margin:12px 0;width:90%;padding:8px;border-radius:8px;border:1px solid #ccc;">
      <div id="game-list" class="menu-list">
        <!-- 示例游戏项 -->
        <div class="game-item">
          <div class="game-icon"></div>
          <div class="game-name">原神</div>
        </div>
        <div class="game-item">
          <div class="game-icon"></div>
          <div class="game-name">我的世界</div>
        </div>
        <!-- 可继续添加 -->
      </div>
    </div>
    <!-- 仪表盘汉堡菜单 -->
    <div id="menu-dashboard" class="hamburger-menu" style="display:none;">
      <div class="menu-header">
        <span>仪表盘</span>
        <button class="menu-close">×</button>
      </div>
      <div id="device-info" style="margin:12px 0;">
        <div>设备名：<span id="device-name">本机</span></div>
        <div>系统：<span id="device-os"></span></div>
      </div>
      <div class="chart-block">
        <div class="chart-title">CPU 频率：<span id="cpu-freq">0 MHz</span></div>
        <canvas id="chart-cpu" width="320" height="80"></canvas>
      </div>
      <div class="chart-block">
        <div class="chart-title">GPU 频率：<span id="gpu-freq">0 MHz</span></div>
        <canvas id="chart-gpu" width="320" height="80"></canvas>
      </div>
      <div class="chart-block">
        <div class="chart-title">内存占用：<span id="mem-usage">0%</span></div>
        <canvas id="chart-mem" width="320" height="80"></canvas>
      </div>
    </div>
    <!-- 消息汉堡菜单 -->
    <div id="menu-message" class="hamburger-menu" style="display:none;">
      <div class="menu-header">
        <span>消息</span>
        <button class="menu-close">×</button>
      </div>
      <div class="message-layout">
        <div class="contacts">
          <div class="contact active">小明</div>
          <div class="contact">小红</div>
        </div>
        <div class="chat-window">
          <div class="chat-history"></div>
          <input type="text" class="chat-input" placeholder="输入消息...">
          <button class="chat-send">发送</button>
        </div>
      </div>
    </div>
    <!-- 账户汉堡菜单 -->
    <div id="menu-account" class="hamburger-menu" style="display:none;">
      <div class="menu-header">
        <span>账户</span>
        <button class="menu-close">×</button>
      </div>
      <div style="text-align:center;margin:18px 0;">
        <img id="avatar-preview" src="默认头像.png" style="width:64px;height:64px;border-radius:50%;object-fit:cover;">
        <input type="file" id="avatar-upload" accept="image/*" style="display:block;margin:8px auto;">
      </div>
      <div>
        <label>昵称：</label>
        <input type="text" id="account-name" style="width:70%;padding:6px;border-radius:8px;border:1px solid #ccc;">
      </div>
      <button id="account-save"
        style="margin-top:16px;width:100%;padding:8px;border-radius:12px;background:#4e8cff;color:#fff;border:none;">保存</button>
    </div>
  </div>

  <!-- 城市选择弹窗（优化风格） -->
  <div id="city-modal"
    style="display:none;position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);align-items:center;justify-content:center;">
    <div style="
        background: rgba(255,255,255,0.55);
        backdrop-filter: blur(18px);
        border-radius: 24px;
        box-shadow: 0 4px 24px rgba(0,0,0,0.10);
        padding: 36px 32px 28px 32px;
        width: 320px;
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        ">
      <button id="city-modal-close" style="
            position: absolute;
            top: 18px;
            right: 22px;
            font-size: 28px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0);
            cursor: pointer;
            transition: color 0.2s;
        " onmouseover="this.style.color='#333'" onmouseout="this.style.color='#888'">×</button>
      <div style="font-size: 22px; font-weight: bold; color: #222; margin-bottom: 18px; letter-spacing: 2px;">
        选择城市
      </div>
      <select id="city-select" style="
            font-size: 20px;
            padding: 10px 18px;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            width: 220px;
            background: rgba(255,255,255,0.7);
            margin-bottom: 22px;
            outline: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            color: #333;
        ">
        <option value="武汉">武汉</option>
        <option value="北京">北京</option>
        <option value="上海">上海</option>
        <option value="广州">广州</option>
        <option value="深圳">深圳</option>
        <option value="成都">成都</option>
        <option value="杭州">杭州</option>
        <option value="南京">南京</option>
        <option value="重庆">重庆</option>
        <option value="西安">西安</option>
        <option value="长沙">长沙</option>
        <option value="苏州">苏州</option>
        <option value="天津">天津</option>
        <option value="郑州">郑州</option>
        <option value="青岛">青岛</option>
        <option value="合肥">合肥</option>
        <option value="福州">福州</option>
        <option value="厦门">厦门</option>
        <option value="济南">济南</option>
        <option value="大连">大连</option>
      </select>
      <button id="city-save-btn" style="
            font-size: 20px;
            padding: 8px 38px;
            border-radius: 14px;
            border: none;
            background: linear-gradient(90deg, #4e8cff 0%, #6ad1ff 100%);
            color: #fff;
            font-weight: bold;
            letter-spacing: 2px;
            box-shadow: 0 2px 8px rgba(78,140,255,0.08);
            cursor: pointer;
            transition: background 0.2s;
        " onmouseover="this.style.background='linear-gradient(90deg,#6ad1ff 0%,#4e8cff 100%)'"
        onmouseout="this.style.background='linear-gradient(90deg,#4e8cff 0%,#6ad1ff 100%)'">
        保存
      </button>
    </div>
  </div>

  <div class="window-container" id="sudokuBox"
    style="border-radius: 22px; z-index:3001;display:none;width:400px;height:348px;backdrop-filter:blur(20px);">
    <!--窗口禁止拉伸-->
    <div class="close-btn" style="color: #000;font-size:30px;top:6px;right:6px;">×</div>
    <div class="title"
      style="color: #000;user-select: none;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;cursor: move;height:52px;width:76%;font-size:20px;top:6px;left:14px;">
      Sudoku</div>
    <iframe id="sudoku-iframe" scrolling="no" src="./Games/Sudoku.html"
      style="width:100%;height:100%;border:none;border-radius:18px 18px 0 0;pointer-events:auto;"></iframe>
  </div>

  <div class="window-container" id="fanbook"
    style="backdrop-filter:blur(20px);z-index:3001;display:none;width:566px;height:410px;">
    <div class="resize-handle nw"></div> <!--方向 西北-->
    <div class="resize-handle ne"></div> <!--方向 东北-->
    <!--<div class="resize-handle sw"></div> 方向 西南-->
    <div class="resize-handle se"></div> <!--方向 东南-->
    <div class="resize-handle n"></div> <!--方向 北-->
    <div class="resize-handle s"></div> <!--方向 南-->
    <div class="resize-handle e"></div> <!--方向 东-->
    <div class="resize-handle w"></div> <!--方向 西-->
    <div class="close-btn" style="color:#000;z-index:9856;">×</div>
    <div class="title"
      style="color: #000;z-index:9856;user-select: none;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;cursor: move;height:52px;width:76%;">
    </div>
    <iframe id="fanbook-iframe" scrolling="no" src="https://web.fanbook.cn/"
      style="width:100%;height:100%;border:none;border-radius:18px 18px 0 0;pointer-events:auto;"></iframe>
  </div>

  <div id="menu" class="context-menu">
    <ul>
      <li>
        <svg width="16" height="16" viewBox="0 0 16 16" style="vertical-align:middle;margin-right:8px;" fill="none"
          xmlns="http://www.w3.org/2000/svg">
          <circle cx="8" cy="8" r="7" stroke="#888" stroke-width="2" />
        </svg>
        复制
      </li>
      <li>
        <svg width="16" height="16" viewBox="0 0 16 16" style="vertical-align:middle;margin-right:8px;" fill="none"
          xmlns="http://www.w3.org/2000/svg">
          <rect x="3" y="3" width="10" height="10" stroke="#888" stroke-width="2" />
        </svg>
        粘贴
      </li>
      <li>
        <svg width="16" height="16" viewBox="0 0 16 16" style="vertical-align:middle;margin-right:8px;" fill="none"
          xmlns="http://www.w3.org/2000/svg">
          <polygon points="8,3 13,13 3,13" stroke="#888" stroke-width="2" fill="none" />
        </svg>
        剪切
      </li>
    </ul>
  </div>

  <script>
    (function () {
      // 只显示一次（首次键盘），但允许手动随时打开
      let shown = false;
      window.showShortcutGuide = function (force) {
        if (shown && !force) return;
        shown = true;
        localStorage.setItem('shortcut_guide_shown', '1');
        // 若已存在则不重复弹出
        if (document.getElementById('shortcut-guide-modal')) return;

        // 弹窗HTML
        const guide = document.createElement('div');
        guide.id = 'shortcut-guide-modal';
        guide.innerHTML = `
        <div class="shortcut-guide-mask"></div>
        <div class="shortcut-guide-content">
          <div class="shortcut-guide-title">快捷键指南</div>
          <ul class="shortcut-guide-list">
            <li><b>Ctrl + 1</b>：Mac窗口</li>
            <li><b>Ctrl + 2</b>：Flyme互联</li>
            <li><b>Ctrl + 3</b>：超级盒子</li>
            <li><b>Ctrl + 4</b>：数独游戏</li>
            <li><b>Ctrl + 5</b>：Fanbook</li>
            <li><b>Ctrl + Shift + S</b>：显示/隐藏超级盒子</li>
            <li><b>Ctrl + Shift + L</b>：打开启动台</li>
            <li><b>Ctrl + Shift + D</b>：显示/隐藏桌面</li>
            <li><b>Ctrl + Shift + Q</b>：关闭当前窗口</li>
            <li><b>Ctrl + Shift + K</b>：打开操作指南</li>
          </ul>
          <button class="shortcut-guide-close">我知道了</button>
        </div>
        `;
        document.body.appendChild(guide);

        // 样式（如已存在则不重复添加）
        if (!document.getElementById('shortcut-guide-style')) {
          const style = document.createElement('style');
          style.id = 'shortcut-guide-style';
          style.textContent = `
          #shortcut-guide-modal {
            position: fixed; z-index: 99999; left: 0; top: 0; width: 100vw; height: 100vh; display: flex;
            align-items: center; justify-content: center;
          }
          .shortcut-guide-mask {
            position: absolute; left: 0; top: 0; width: 100vw; height: 100vh;
            background: rgba(30,32,38,0.32); backdrop-filter: blur(8px);
          }
          .shortcut-guide-content {
            position: relative;
            background: rgba(255,255,255,0.55);
            backdrop-filter: blur(24px) saturate(140%);
            border-radius: 24px;
            box-shadow: 0 8px 32px #4e8cff33, 0 2px 8px #0002;
            padding: 38px 38px 28px 38px;
            min-width: 340px;
            max-width: 92vw;
            color: #222;
            animation: shortcut-guide-in 0.32s cubic-bezier(.4,0,.2,1);
            font-family: 'Chillax', Arial, sans-serif;
          }
          @keyframes shortcut-guide-in {
            from { opacity: 0; transform: scale(0.92);}
            to { opacity: 1; transform: scale(1);}
          }
          .shortcut-guide-title {
            font-size: 26px;
            font-weight: bold;
            letter-spacing: 2px;
            margin-bottom: 18px;
            color: #4e8cff;
            text-align: center;
          }
          .shortcut-guide-list {
            list-style: none;
            padding: 0;
            margin: 0 0 18px 0;
          }
          .shortcut-guide-list li {
            font-size: 18px;
            margin: 10px 0;
            color: #333;
            background: rgba(136,177,241,0.08);
            border-radius: 10px;
            padding: 7px 16px;
            transition: background 0.2s;
          }
          .shortcut-guide-list li b {
            color: #4e8cff;
            font-weight: 800;
            font-size: 17px;
            margin-right: 10px;
            font-family: 'Chillax', Arial, sans-serif;
          }
          .shortcut-guide-close {
            display: block;
            margin: 0 auto;
            padding: 10px 38px;
            font-size: 18px;
            border-radius: 14px;
            border: none;
            background: linear-gradient(90deg, #4e8cff 0%, #6ad1ff 100%);
            color: #fff;
            font-weight: bold;
            letter-spacing: 2px;
            box-shadow: 0 2px 8px #4e8cff22;
            cursor: pointer;
            transition: background 0.2s;
          }
          .shortcut-guide-close:hover {
            background: linear-gradient(90deg, #6ad1ff 0%, #4e8cff 100%);
            color: #fff;
          }
        `;
          document.head.appendChild(style);
        }

        // 关闭
        guide.querySelector('.shortcut-guide-close').onclick =
          guide.querySelector('.shortcut-guide-mask').onclick = function () {
            guide.remove();
          };
      };

      // 首次键盘按下时弹出
      if (!localStorage.getItem('shortcut_guide_shown')) {
        window.addEventListener('keydown', function once() {
          window.showShortcutGuide();
          window.removeEventListener('keydown', once, true);
        }, true);
      }
    })();

    // 快捷键操作
    document.addEventListener('keydown', function (e) {
      // 忽略输入框/textarea等输入时
      const tag = (e.target.tagName || '').toLowerCase();
      if (tag === 'input' || tag === 'textarea' || e.target.isContentEditable) return;

      // Ctrl+1~5 快速打开窗口
      if (e.ctrlKey && !e.shiftKey && !e.altKey) {
        if (e.key === '1') { openWindow('macWindow'); e.preventDefault(); }
        if (e.key === '2') { openWindow('flyme-linkpc'); e.preventDefault(); }
        if (e.key === '3') { openWindow('windowBox'); e.preventDefault(); }
        if (e.key === '4') { openWindow('sudokuBox'); e.preventDefault(); }
        if (e.key === '5') { openWindow('fanbook'); e.preventDefault(); }
      }
      // Ctrl+Shift+S 显示/隐藏超级盒子
      if (e.ctrlKey && e.shiftKey && !e.altKey && (e.key === 'S' || e.key === 's')) {
        const win = windows.find(w => w.id === 'windowBox');
        if (win) {
          if (win.isOpen && !win.isMinimized && win.el.style.display !== 'none') {
            closeWindow('windowBox');
          } else {
            openWindow('windowBox');
          }
          e.preventDefault();
        }
      }
      // Ctrl+Shift+L 打开启动台
      if (e.ctrlKey && e.shiftKey && !e.altKey && (e.key === 'L' || e.key === 'l')) {
        openLaunchpad();
        e.preventDefault();
      }
      // Ctrl+Shift+K 打开操作指南
      if (e.ctrlKey && e.shiftKey && !e.altKey && (e.key === 'K' || e.key === 'k')) {
        showShortcutGuide(true);
        e.preventDefault();
      }
      // Ctrl+Shift+D 显示/隐藏桌面
      if (e.ctrlKey && e.shiftKey && !e.altKey && (e.key === 'D' || e.key === 'd')) {
        document.getElementById('show-desktop-btn').click();
        e.preventDefault();
      }
      // Ctrl+Shift+Q 关闭当前最顶层窗口
      if (e.ctrlKey && e.shiftKey && !e.altKey && (e.key === 'Q' || e.key === 'q')) {
        // 找到zIndex最大的已打开窗口
        let openWins = windows.filter(w => w.isOpen && !w.isMinimized && w.el.style.display !== 'none' && !w.el.classList.contains('hidden'));
        if (openWins.length > 0) {
          openWins.sort((a, b) => (parseInt(b.el.style.zIndex) || 0) - (parseInt(a.el.style.zIndex) || 0));
          closeWindow(openWins[0].id);
          e.preventDefault();
        }
      }
    });

    // 在账户菜单添加“是否显示LOGO”开关
    (function () {
      const menuAccount = document.getElementById('menu-account');
      if (menuAccount && !document.getElementById('logo-toggle')) {
        // 插入到昵称输入框下方
        const nameInput = document.getElementById('account-name');
        const logoDiv = document.createElement('div');
        logoDiv.style = "margin:18px 0;text-align:left;";
        logoDiv.innerHTML = `
      <label style="font-size:16px;vertical-align:middle;">
        <input type="checkbox" id="logo-toggle" style="vertical-align:middle;margin-right:6px;">
        显示LOGO
      </label>
    `;
        nameInput.parentNode.parentNode.insertBefore(logoDiv, nameInput.parentNode.nextSibling);

        // 读取本地设置
        const logoShow = localStorage.getItem('show_logo') !== 'false';
        document.getElementById('logo-toggle').checked = logoShow;

        // 切换事件
        document.getElementById('logo-toggle').onchange = function () {
          const show = this.checked;
          localStorage.setItem('show_logo', show);
          setLogoShow(show);
        };
      }

      // 控制LOGO显示/隐藏
      function setLogoShow(show) {
        const logoDiv = document.querySelector('#windowBox .title');
        if (logoDiv) {
          logoDiv.textContent = show ? 'SHOOTING STAR' : '   ';
        }
      }

      // 打开账户菜单时同步开关和LOGO
      const accountBtn = document.querySelector('.nav-btns button:last-child');
      if (accountBtn) {
        accountBtn.addEventListener('click', function () {
          const logoShow = localStorage.getItem('show_logo') !== 'false';
          document.getElementById('logo-toggle').checked = logoShow;
          setLogoShow(logoShow);
        });
      }

      // 页面加载时同步LOGO
      document.addEventListener('DOMContentLoaded', function () {
        const logoShow = localStorage.getItem('show_logo') !== 'false';
        setLogoShow(logoShow);
      });
    })();

    // 在账户汉堡菜单添加“修改背景图片”功能
    (function () {
      // 在账户菜单插入上传控件
      const menuAccount = document.getElementById('menu-account');
      if (menuAccount && !document.getElementById('bg-upload')) {
        // 插入到头像下方
        const avatarDiv = menuAccount.querySelector('div[style*="text-align:center"]');
        const bgDiv = document.createElement('div');
        bgDiv.style = "text-align:center;margin:18px 0;";
        bgDiv.innerHTML = `
      <img id="bg-preview" src="./PIC/cjbox.jpg" style="width:64px;height:36px;border-radius:8px;object-fit:cover;display:block;margin:0 auto 8px;">
      <input type="file" id="bg-upload" accept="image/*" style="display:block;margin:8px auto;">
      <button id="bg-save" style="margin-top:8px;width:100%;padding:8px;border-radius:12px;background:#4e8cff;color:#fff;border:none;">保存背景</button>
    `;
        avatarDiv.parentNode.insertBefore(bgDiv, avatarDiv.nextSibling);

        // 预览和保存
        let bgDataUrl = null;
        document.getElementById('bg-upload').onchange = function (e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (ev) {
              bgDataUrl = ev.target.result;
              document.getElementById('bg-preview').src = bgDataUrl;
            };
            reader.readAsDataURL(file);
          }
        };
        document.getElementById('bg-save').onclick = function () {
          if (bgDataUrl) {
            localStorage.setItem('cjbox_bg', bgDataUrl);
            showNotification({ title: '保存成功', message: '背景图片已保存' });
            // 立即应用
            setWindowBoxBg(bgDataUrl);
          }
        };
      }

      // 打开账户菜单时自动预览
      const accountBtn = document.querySelector('.nav-btns button:last-child');
      if (accountBtn) {
        accountBtn.addEventListener('click', function () {
          const bg = localStorage.getItem('cjbox_bg');
          document.getElementById('bg-preview').src = bg || './PIC/cjbox.jpg';
        });
      }

      // 应用背景到 windowBox
      function setWindowBoxBg(bg) {
        const img = document.querySelector('#windowBox > img');
        if (img) img.src = bg || './PIC/cjbox.jpg';
      }

      // 页面加载时检查本地背景
      document.addEventListener('DOMContentLoaded', function () {
        const bg = localStorage.getItem('cjbox_bg');
        setWindowBoxBg(bg);
      });

      // 每次打开超级盒子窗口时检查背景
      const origOpenWindow = window.openWindow;
      window.openWindow = function (id) {
        if (id === 'windowBox') {
          const bg = localStorage.getItem('cjbox_bg');
          setWindowBoxBg(bg);
        }
        origOpenWindow.apply(this, arguments);
      };
    })();

    (function () {
      const box = document.getElementById('fanbook');
      if (!box) return;
      const minWidth = 400, minHeight = 250;
      let startX, startY, startW, startH, startL, startT, dir;

      function onMouseMove(e) {
        let dx = e.clientX - startX;
        let dy = e.clientY - startY;
        let newW = startW, newH = startH, newL = startL, newT = startT;

        if (dir === 'e') newW = Math.max(minWidth, startW + dx);
        if (dir === 'w') {
          newW = Math.max(minWidth, startW - dx);
          newL = startL + dx;
        }
        if (dir === 's') newH = Math.max(minHeight, startH + dy);
        if (dir === 'n') {
          newH = Math.max(minHeight, startH - dy);
          newT = startT + dy;
        }
        if (dir === 'se') {
          newW = Math.max(minWidth, startW + dx);
          newH = Math.max(minHeight, startH + dy);
        }
        if (dir === 'sw') {
          newW = Math.max(minWidth, startW - dx);
          newL = startL + dx;
          newH = Math.max(minHeight, startH + dy);
        }
        if (dir === 'ne') {
          newW = Math.max(minWidth, startW + dx);
          newH = Math.max(minHeight, startH - dy);
          newT = startT + dy;
        }
        if (dir === 'nw') {
          newW = Math.max(minWidth, startW - dx);
          newL = startL + dx;
          newH = Math.max(minHeight, startH - dy);
          newT = startT + dy;
        }

        box.style.width = newW + 'px';
        box.style.height = newH + 'px';
        box.style.left = newL + 'px';
        box.style.top = newT + 'px';
      }

      function onMouseUp() {
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
      }

      // 拉伸手柄
      box.querySelectorAll('.resize-handle').forEach(handle => {
        handle.addEventListener('mousedown', function (e) {
          e.preventDefault();
          dir = this.className.split(' ')[1];
          const rect = box.getBoundingClientRect();
          startX = e.clientX;
          startY = e.clientY;
          startW = rect.width;
          startH = rect.height;
          startL = box.offsetLeft;
          startT = box.offsetTop;
          box.style.position = 'absolute';
          document.addEventListener('mousemove', onMouseMove);
          document.addEventListener('mouseup', onMouseUp);
        });
      });

      // 拖动
      box.addEventListener('mousedown', function (e) {
        if (
          e.target.classList.contains('resize-handle') ||
          e.target.classList.contains('close-btn') ||
          e.target.classList.contains('nav-btn') ||
          e.target.classList.contains('start-btn')
        ) return;
        let isDragging = true;
        let dragOffsetX = e.clientX - box.offsetLeft;
        let dragOffsetY = e.clientY - box.offsetTop;
        let prevTransition = box.style.transition;
        box.style.transition = 'none';
        box.style.position = 'absolute';

        function onMove(ev) {
          if (!isDragging) return;
          let newL = ev.clientX - dragOffsetX;
          let newT = ev.clientY - dragOffsetY;
          newL = Math.max(0, Math.min(newL, window.innerWidth - box.offsetWidth));
          newT = Math.max(0, Math.min(newT, window.innerHeight - box.offsetHeight));
          box.style.left = newL + 'px';
          box.style.top = newT + 'px';
        }
        function onUp() {
          isDragging = false;
          box.style.transition = prevTransition;
          document.removeEventListener('mousemove', onMove);
          document.removeEventListener('mouseup', onUp);
        }
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
      });

      // 关闭按钮
      box.querySelector('.close-btn').onclick = function () {
        closeWindow('fanbook');
        const win = windows.find(w => w.id === 'fanbook');
        if (win) {
          win.isOpen = false;
          win.isMinimized = false;
          updateTaskbarWindows();
          updateTaskbarVisibility();
        }
      };
    })();

    // 桌面快捷方式自适应布局（左上角竖向排列）
    function layoutDesktopShortcuts() {
      const desktop = document.getElementById('desktop');
      const shortcuts = Array.from(desktop.querySelectorAll('.desktop-shortcut'));
      // 图标尺寸和间距
      const iconW = 80, iconH = 80, gapX = 32, gapY = 32;
      // 桌面区域尺寸
      const ww = window.innerWidth, wh = window.innerHeight;
      // 计算每列能放多少个
      const maxRows = Math.max(1, Math.floor((wh - 80) / (iconH + gapY)));
      // 左上角起始点
      const startX = 20;
      const startY = 32;

      shortcuts.forEach((el, i) => {
        // 竖向排列：先排满一列再换列
        const row = i % maxRows;
        const col = Math.floor(i / maxRows);
        el.style.position = 'absolute';
        el.style.left = (startX + col * (iconW + gapX)) + 'px';
        el.style.top = (startY + row * (iconH + gapY)) + 'px';
      });
    }

    // 初始化和窗口变化时布局
    window.addEventListener('resize', layoutDesktopShortcuts);
    document.addEventListener('DOMContentLoaded', layoutDesktopShortcuts);

    // 记录被隐藏的窗口
    let desktopHiddenWindows = null;

    document.getElementById('show-desktop-btn').onclick = function () {
      if (desktopHiddenWindows) {
        desktopHiddenWindows.forEach(id => {
          const win = windows.find(w => w.id === id);
          if (win) {
            if (win.id === 'windowBox') {
              win.el.style.display = '';
            }
            win.el.classList.remove('hidden');
            win.isOpen = true;
            win.isMinimized = false;
          }
        });
        desktopHiddenWindows = null;
      } else {
        desktopHiddenWindows = windows.filter(win => win.isOpen && !win.isMinimized && (win.el.style.display !== 'none' && !win.el.classList.contains('hidden'))).map(win => win.id);
        windows.forEach(win => {
          if (win.isOpen && !win.isMinimized) {
            if (win.id === 'windowBox') {
              win.el.style.display = 'none';
            }
            win.el.classList.add('hidden');
            win.isMinimized = true;
          }
        });
      }
      updateTaskbarWindows();
      updateTaskbarVisibility();
    };

    document.getElementById('random-component').onclick = function () {
      const text = document.getElementById('hitokoto').innerText;
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(function () {
          showNotification({ title: '已复制到剪贴板', message: text });
        }, function () {
          showNotification({ title: '复制失败', message: '请检查浏览器权限' });
        });
      } else {
        // 兼容旧浏览器
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        try {
          document.execCommand('copy');
          showNotification({ title: '已复制到剪贴板', message: text });
        } catch (err) {
          showNotification({ title: '复制失败', message: '' });
        }
        document.body.removeChild(textarea);
      }
    };
    // 启动台搜索逻辑
    (function () {
      const searchInput = document.getElementById('launchpad-search-input');
      const searchBtn = document.getElementById('launchpad-search-btn');
      const launchpad = document.getElementById('launchpad');
      const content = launchpad.querySelector('.launchpad-content');

      // 应用列表（与renderLaunchpad一致）
      const APPS = [
        { icon: './PIC/Mac.png', name: 'Mac窗口', app: 'macWindow' },
        { icon: './PIC/flymelink.svg', name: 'Flyme 互联', app: 'flyme-linkpc' },
        { icon: './PIC/windowBox.svg', name: '超级盒子', app: 'windowBox' },
        { icon: './PIC/Sudoku.png', name: '数独游戏', app: 'sudokuBox' },
        { icon: './PIC/fanbook.png', name: 'Fanbook', app: 'fanbook' },
        { icon: 'https://img.icons8.com/fluency/48/keyboard.png', name: '操作指南', app: 'shortcutGuide' }
      ];

      function searchApps(keyword) {
        const kw = keyword.trim().toLowerCase();
        if (!kw) return APPS;
        return APPS.filter(app =>
          app.name.toLowerCase().includes(kw) ||
          app.app.toLowerCase().includes(kw)
        );
      }

      function renderSearchResult(keyword) {
        const apps = searchApps(keyword);
        content.innerHTML = '';
        if (apps.length > 0) {
          apps.forEach(app => {
            const el = document.createElement('div');
            el.className = 'launchpad-app';
            el.dataset.app = app.app;
            el.innerHTML = `<img src="${app.icon}" alt="${app.name}" /><span>${app.name}</span>`;
            el.onclick = function () {
              // 支持操作指南
              if (app.app === 'shortcutGuide') {
                showShortcutGuide(true);
                closeLaunchpad();
              } else {
                openWindow(app.app);
                closeLaunchpad();
              }
            };
            content.appendChild(el);
          });
        } else {
          // 无本地应用，显示网页搜索建议
          const tip = document.createElement('div');
          tip.style.cssText = "color:#bcd;text-align:center;font-size:17px;margin:38px auto 0;";
          tip.innerHTML = `未找到本地应用，可直接网页搜索：<br><span style="color:#88B1F1;">${keyword}</span>`;
          content.appendChild(tip);
        }
      }

      // 输入时本地应用搜索
      searchInput.addEventListener('input', function () {
        renderSearchResult(this.value);
      });

      // 回车或点击按钮网页搜索
      function doWebSearch() {
        const kw = searchInput.value.trim();
        if (kw) {
          window.open('https://www.bing.com/search?q=' + encodeURIComponent(kw), '_blank');
        }
      }
      searchBtn.onclick = doWebSearch;
      searchInput.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
          // 若有本地应用则优先打开，否则网页搜索
          const apps = searchApps(this.value);
          if (apps.length > 0) {
            openWindow(apps[0].app);
            closeLaunchpad();
          } else {
            doWebSearch();
          }
        }
      });

      // 启动台每次打开时清空搜索
      const origOpenLaunchpad = openLaunchpad;
      window.openLaunchpad = function () {
        searchInput.value = '';
        renderLaunchpad(0);
        content.scrollTop = 0;
        origOpenLaunchpad();
        setTimeout(() => searchInput.focus(), 120);
      };
    })();

    (function () {
      const engines = [
        { name: 'Bing', icon: 'https://www.bing.com/favicon.ico', url: 'https://www.bing.com/search?q=' },
        { name: '百度', icon: 'https://www.baidu.com/favicon.ico', url: 'https://www.baidu.com/s?wd=' },
        { name: 'Google', icon: './PIC/google.ico', url: 'https://www.google.com/search?q=' },
        { name: 'DuckDuckGo', icon: './PIC/DuckDuckGo.svg', url: 'https://duckduckgo.com/?q=' }
      ];
      // 读取本地存储
      let current = Number(localStorage.getItem('search_engine_index')) || 0;
      if (current < 0 || current >= engines.length) current = 0;
      const btn = document.getElementById('search-engine-btn');
      const icon = document.getElementById('search-engine-icon');
      const nameSpan = document.getElementById('search-engine-name');
      const list = document.getElementById('search-engine-list');
      const input = document.getElementById('launchpad-search-input');
      const searchBtn = document.getElementById('launchpad-search-btn');

      // 初始化显示
      icon.src = engines[current].icon;
      nameSpan.textContent = engines[current].name;

      // 展开/收起下拉
      btn.onclick = function (e) {
        e.stopPropagation();
        list.style.display = list.style.display === 'block' ? 'none' : 'block';
      };
      // 选择
      list.querySelectorAll('div').forEach((item, idx) => {
        item.onclick = function (e) {
          e.stopPropagation();
          current = idx;
          icon.src = engines[idx].icon;
          nameSpan.textContent = engines[idx].name;
          list.style.display = 'none';
          // 自动保存
          localStorage.setItem('search_engine_index', idx);
        };
      });
      // 点击外部关闭
      document.addEventListener('click', () => { list.style.display = 'none'; });

      // 搜索按钮和回车
      function doSearch() {
        const kw = input.value.trim();
        if (kw) {
          // 根据文本长度动态选择搜索引擎
          let engineIdx = current;
          if (kw.length > 40) {
            // 长文本优先用百度
            engineIdx = 1; // 百度
            icon.src = engines[engineIdx].icon;
            nameSpan.textContent = engines[engineIdx].name;
            localStorage.setItem('search_engine_index', engineIdx);
          }
          window.open(engines[engineIdx].url + encodeURIComponent(kw), '_blank');
        }
      }
      searchBtn.onclick = doSearch;
      input.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') doSearch();
      });
    })();

    // 复制
    document.querySelector('#menu ul li:nth-child(1)').onclick = function () {
      if (contextTargetInput) {
        // 针对输入框
        const input = contextTargetInput;
        if (input.selectionStart !== input.selectionEnd) {
          const selected = input.value.substring(input.selectionStart, input.selectionEnd);
          navigator.clipboard.writeText(selected);
          showNotification({ title: '已复制', message: selected });
        } else {
          showNotification({ title: '提示', message: '请先选中要复制的内容' });
        }
      } else {
        // 原有逻辑
        const selection = window.getSelection();
        if (selection && selection.toString()) {
          navigator.clipboard.writeText(selection.toString());
          showNotification({ title: '已复制', message: selection.toString() });
        } else {
          showNotification({ title: '提示', message: '请先选中要复制的内容' });
        }
      }
    };

    // 粘贴
    document.querySelector('#menu ul li:nth-child(2)').onclick = async function () {
      const text = await navigator.clipboard.readText();
      if (contextTargetInput) {
        // 针对输入框
        const input = contextTargetInput;
        const start = input.selectionStart, end = input.selectionEnd;
        const value = input.value;
        input.value = value.slice(0, start) + text + value.slice(end);
        input.selectionStart = input.selectionEnd = start + text.length;
        showNotification({ title: '已粘贴', message: text });
        input.focus();
      } else {
        // 原有逻辑
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
          selection.deleteFromDocument();
          selection.getRangeAt(0).insertNode(document.createTextNode(text));
          showNotification({ title: '已粘贴', message: text });
        }
      }
      // 恢复菜单文字
      setTimeout(() => {
        document.querySelector('#menu ul li:nth-child(2)').innerHTML = `
      <svg width="16" height="16" viewBox="0 0 16 16" style="vertical-align:middle;margin-right:8px;" fill="none"
        xmlns="http://www.w3.org/2000/svg">
        <rect x="3" y="3" width="10" height="10" stroke="#888" stroke-width="2" />
      </svg>
      粘贴
    `;
      }, 10);
    };

    // 剪切
    document.querySelector('#menu ul li:nth-child(3)').onclick = function () {
      if (contextTargetInput) {
        // 针对输入框
        const input = contextTargetInput;
        if (input.selectionStart !== input.selectionEnd) {
          const selected = input.value.substring(input.selectionStart, input.selectionEnd);
          navigator.clipboard.writeText(selected);
          // 删除选中内容
          input.value = input.value.slice(0, input.selectionStart) + input.value.slice(input.selectionEnd);
          input.selectionEnd = input.selectionStart;
          showNotification({ title: '已剪切', message: selected });
          input.focus();
        } else {
          showNotification({ title: '提示', message: '请先选中要剪切的内容' });
        }
      } else {
        // 原有逻辑
        const selection = window.getSelection();
        if (selection && selection.toString()) {
          navigator.clipboard.writeText(selection.toString());
          selection.deleteFromDocument();
          showNotification({ title: '已剪切', message: selection.toString() });
        } else {
          showNotification({ title: '提示', message: '请先选中要剪切的内容' });
        }
      }
    };

    function showNotification({ title, message, image, showImage = false, buttons = [], icon }) {
      const container = document.getElementById('tzNotificationContainer');
      const div = document.createElement('div');
      div.className = 'tz-notification';

      // 构建按钮HTML
      let buttonsHtml = '';
      if (Array.isArray(buttons) && buttons.length > 0) {
        buttons.slice(0, 2).forEach((btn, idx) => {
          buttonsHtml += `<button class="tz-notification-action" data-btn-idx="${idx}">${btn.text}</button>`;
        });
      }

      //通知svg备份
      //${icon || `<svg width="22" height="22" viewBox="0 0 24 24" fill="none">
      //<circle cx="12" cy="12" r="10" fill="white" fill-opacity="0.2"/>
      //<path d="M12 8v4M12 16h.01" stroke="white" stroke-width="2" stroke-linecap="round"/>
      //</svg>`}

      div.innerHTML = `
        <div class="tz-notification-icon">
          <img src="./PIC/windowBox.svg" alt="通知" style="width:22px;height:22px;border-radius:6px;">
        </div>
        <div class="tz-notification-content">
          ${showImage && image ? `<img class="tz-notification-image" src="${image}" alt="通知图片">` : ''}
          <div class="tz-notification-title">${title || '通知标题'}</div>
          <div class="tz-notification-message">${message || ''}</div>
          ${buttonsHtml ? `<div class="tz-notification-actions">${buttonsHtml}</div>` : ''}
        </div>
        <button class="tz-notification-close" onclick="this.parentElement.remove()">&times;</button>
      `;
      container.appendChild(div);

      // 关闭按钮动画
      div.querySelector('.tz-notification-close').onclick = function () {
        div.classList.add('tz-leave');
        setTimeout(() => div.remove(), 380);
      };

      // 绑定按钮事件
      if (Array.isArray(buttons) && buttons.length > 0) {
        div.querySelectorAll('.tz-notification-action').forEach((btnEl, idx) => {
          btnEl.onclick = (e) => {
            e.stopPropagation();
            if (typeof buttons[idx].onClick === 'function') {
              buttons[idx].onClick(div);
            }
          };
        });
      }

      // 自动消失（可选，按钮存在时不自动消失）
      if (!buttonsHtml) {
        setTimeout(() => {
          if (div.parentNode) {
            div.classList.add('tz-leave');
            setTimeout(() => div.remove(), 380);
          }
        }, 3000);
      }
    }

    let snapHint = null;
    function showSnapHint(type) {
      if (!snapHint) {
        snapHint = document.createElement('div');
        snapHint.className = 'snap-hint';
        document.body.appendChild(snapHint);
      }
      snapHint.className = 'snap-hint ' + type;
    }
    function hideSnapHint() {
      if (snapHint) {
        snapHint.remove();
        snapHint = null;
      }
    }
    function getSnapType(e) {
      const margin = 40;
      const w = window.innerWidth, h = window.innerHeight;
      const nearLeft = e.clientX < margin;
      const nearRight = e.clientX > w - margin;
      const nearTop = e.clientY < margin;
      const nearBottom = e.clientY > h - margin;

      if (nearLeft && nearTop) return "topleft";
      if (nearRight && nearTop) return "topright";
      if (nearLeft && nearBottom) return "bottomleft";
      if (nearRight && nearBottom) return "bottomright";
      if (nearLeft) return "left";
      if (nearRight) return "right";
      if (nearTop) return "top";
      return "";
    }
    const box = document.getElementById('windowBox');
    const minWidth = 400,
      minHeight = 250;
    const aspectRatio = 900 / 510; // 宽高比
    let startX, startY, startW, startH, startL, startT, dir;

    function onMouseMove(e) {
      let dx = e.clientX - startX;
      let dy = e.clientY - startY;
      let newW = startW,
        newH = startH,
        newL = startL,
        newT = startT;

      if (dir === 'e' || dir === 'w') {
        if (dir === 'e') newW = Math.max(minWidth, startW + dx);
        if (dir === 'w') {
          newW = Math.max(minWidth, startW - dx);
          newL = startL + dx;
        }
        newH = newW / aspectRatio;
        if (newH < minHeight) {
          newH = minHeight;
          newW = newH * aspectRatio;
        }
      } else if (dir === 'n' || dir === 's') {
        if (dir === 's') newH = Math.max(minHeight, startH + dy);
        if (dir === 'n') {
          newH = Math.max(minHeight, startH - dy);
          newT = startT + dy;
        }
        newW = newH * aspectRatio;
        if (newW < minWidth) {
          newW = minWidth;
          newH = newW / aspectRatio;
        }
      } else {
        let delta = 0;
        if (dir === 'se') delta = Math.max(dx, dy);
        if (dir === 'sw') delta = Math.max(-dx, dy);
        if (dir === 'ne') delta = Math.max(dx, -dy);
        if (dir === 'nw') delta = Math.max(-dx, -dy);

        if (dir === 'se' || dir === 'ne') {
          newW = Math.max(minWidth, startW + delta);
          newH = newW / aspectRatio;
        } else if (dir === 'sw' || dir === 'nw') {
          newW = Math.max(minWidth, startW - delta);
          newL = startL + delta;
          newH = newW / aspectRatio;
        }

        if (dir === 'ne' || dir === 'nw') {
          newT = startT - (newH - startH);
        }
        if (newH < minHeight) {
          newH = minHeight;
          newW = newH * aspectRatio;
        }
        if (newW < minWidth) {
          newW = minWidth;
          newH = newW / aspectRatio;
        }
      }

      box.style.width = newW + 'px';
      box.style.height = newH + 'px';
      box.style.left = newL + 'px';
      box.style.top = newT + 'px';
    }

    function onMouseUp() {
      document.removeEventListener('mousemove', onMouseMove);
      document.removeEventListener('mouseup', onMouseUp);

      // 拉伸结束后重新调整两个圆角矩形的位置和大小，确保内容适配
      adjustRoundedRectPositionById('weather-component', 'weather-text', []);
      const weatherRect = getRoundedRectInfo('weather-component');
      adjustRoundedRectPositionById('random-component', 'hitokoto', weatherRect ? [weatherRect] : []);
    }

    document.querySelectorAll('.resize-handle').forEach(handle => {
      handle.addEventListener('mousedown', function (e) {
        e.preventDefault();
        dir = this.className.split(' ')[1];
        const rect = box.getBoundingClientRect();
        startX = e.clientX;
        startY = e.clientY;
        startW = rect.width;
        startH = rect.height;
        startL = box.offsetLeft;
        startT = box.offsetTop;
        box.style.position = 'absolute';
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
      });
    });

    // 超级盒子 windowBox 显示/隐藏时也要更新任务栏避让
    document.getElementById('showWindowBox').onclick = function () {
      openWindow('windowBox');
      updateTaskbarVisibility(); // 新增
    };
    document.querySelector('.close-btn').onclick = function () {
      closeWindow('windowBox');
      // 修复：同步关闭状态，移除任务栏图标
      const win = windows.find(w => w.id === 'windowBox');
      if (win) {
        win.isOpen = false;
        win.isMinimized = false;
        updateTaskbarWindows();
        updateTaskbarVisibility();
      }
    };


    // 判断两个矩形是否重叠
    function isRectOverlap(r1, r2) {
      return !(r1.left + r1.width <= r2.left ||
        r2.left + r2.width <= r1.left ||
        r1.top + r1.height <= r2.top ||
        r2.top + r2.height <= r1.top);
    }

    // 动态避让的通用位置调整函数
    function adjustRoundedRectPositionById(componentId, textId, avoidRects = []) {
      const textElement = document.getElementById(textId);
      const componentElement = document.getElementById(componentId);
      const windowBox = document.getElementById('windowBox');

      // 先重置样式
      textElement.style.fontSize = '22px';
      textElement.style.whiteSpace = 'nowrap';
      componentElement.style.width = 'auto';
      componentElement.style.height = 'auto';

      setTimeout(() => {
        const maxWidth = 400;
        const minWidth = 120;
        const maxHeight = windowBox.offsetHeight - 40; // 预留边距
        let width = textElement.scrollWidth + 48;
        let height = textElement.scrollHeight + 36;

        // 先调整字号
        if (width > maxWidth) {
          textElement.style.fontSize = '18px';
          width = textElement.scrollWidth + 48;
          height = textElement.scrollHeight + 36;
        }
        // 再判断是否需要换行
        if (width > maxWidth) {
          width = maxWidth;
          textElement.style.whiteSpace = 'pre-line';
          textElement.style.wordBreak = 'break-all';
          // 重新计算高度
          componentElement.style.width = width + 'px';
          setTimeout(() => {
            height = textElement.scrollHeight + 36;
            if (height > maxHeight) height = maxHeight;
            componentElement.style.height = height + 'px';
            // 修正：同步max-width，防止文字溢出
            textElement.style.maxWidth = width - 24 + 'px';
          }, 0);
        } else {
          textElement.style.whiteSpace = 'nowrap';
          componentElement.style.height = 'auto';
          // 修正：同步max-width，防止文字溢出
          textElement.style.maxWidth = width - 24 + 'px';
        }
        if (width < minWidth) width = minWidth;
        if (height > maxHeight) height = maxHeight;
        componentElement.style.width = width + 'px';
        componentElement.style.height = height + 'px';
        // 修正：同步max-width，防止文字溢出
        textElement.style.maxWidth = width - 24 + 'px';

        // 定位逻辑
        const boxRect = windowBox.getBoundingClientRect();
        const rectWidth = width;
        const rectHeight = componentElement.offsetHeight;

        const centerWidth = boxRect.width * 0.6;
        const centerHeight = boxRect.height * 0.6;
        const minLeft = (boxRect.width - centerWidth) / 2;
        const minTop = (boxRect.height - centerHeight) / 2;
        const maxLeft = minLeft + centerWidth - rectWidth;
        const maxTop = minTop + centerHeight - rectHeight;

        let left, top, tryCount = 0, maxTry = 30, found = false;
        do {
          left = Math.random() * (maxLeft - minLeft) + minLeft;
          top = Math.random() * (maxTop - minTop) + minTop;
          const thisRect = { left, top, width: rectWidth, height: rectHeight };
          found = avoidRects.every(r => !isRectOverlap(thisRect, r));
          tryCount++;
        } while (
          (!found || left < 0 || top < 0 || left + rectWidth > boxRect.width || top + rectHeight > boxRect.height)
          && tryCount < maxTry
        );
        left = Math.max(0, Math.min(left, boxRect.width - rectWidth));
        top = Math.max(0, Math.min(top, boxRect.height - rectHeight));

        componentElement.style.left = left + 'px';
        componentElement.style.top = top + 'px';
        componentElement.style.visibility = 'visible';
      }, 50);
    }

    // 获取某个圆角矩形的相对windowBox的矩形信息
    function getRoundedRectInfo(componentId) {
      const el = document.getElementById(componentId);
      const box = document.getElementById('windowBox');
      if (!el || el.style.visibility === 'hidden') return null;
      const boxRect = box.getBoundingClientRect();
      const elRect = el.getBoundingClientRect();
      return {
        left: elRect.left - boxRect.left,
        top: elRect.top - boxRect.top,
        width: el.offsetWidth,
        height: el.offsetHeight
      };
    }
    // 一言加载与避让天气
    fetch('https://v1.hitokoto.cn/?c=b')
      .then(response => response.json())
      .then(data => {
        const hitokotoElement = document.getElementById('hitokoto');
        const randomComponentElement = document.getElementById('random-component');
        randomComponentElement.style.visibility = 'hidden';
        hitokotoElement.textContent = data.hitokoto;
        // 避让天气组件
        const weatherRect = getRoundedRectInfo('weather-component');
        adjustRoundedRectPositionById('random-component', 'hitokoto', weatherRect ? [weatherRect] : []);
      })
      .catch(error => {
        console.error('Error fetching data:', error);
        document.getElementById('hitokoto').textContent = '获取一言失败';
        document.getElementById('random-component').style.visibility = 'visible';
        // 同理，失败通知也延后
        function showHitokotoFailNotification() {
          showNotification({ title: '一言获取失败', message: '无法获取一言内容' });
        }
        if (mainContent && mainContent.style.display === '') {
          showHitokotoFailNotification();
        } else {
          const observer = new MutationObserver(() => {
            if (mainContent && mainContent.style.display === '') {
              showHitokotoFailNotification();
              observer.disconnect();
            }
          });
          observer.observe(mainContent, { attributes: true, attributeFilter: ['style'] });
        }
      });

    // 获取本地存储的城市名，没有则默认武汉
    function getWeatherCity() {
      return localStorage.getItem('weather_city') || '武汉';
    }

    function setWeatherCity(city) {
      localStorage.setItem('weather_city', city);
    }

    // 封装天气加载
    function loadWeather() {
      const city = getWeatherCity();
      fetch(`https://api.vvhan.com/api/weather?type=now&city=${encodeURIComponent(city)}`)
        .then(response => response.json())
        .then(data => {
          const weatherText = document.getElementById('weather-text');
          const weatherComponent = document.getElementById('weather-component');
          weatherComponent.style.visibility = 'hidden';
          if (data && data.success && data.data && data.data.type && data.data.high) {
            const temp = data.data.high.replace('°C', '°C').replace('℃', '°C');
            weatherText.textContent = `${data.data.type} ${temp}`;
          } else {
            weatherText.textContent = '晴 25°C'; // 默认内容
          }
          const hitokotoRect = getRoundedRectInfo('random-component');
          adjustRoundedRectPositionById('weather-component', 'weather-text', hitokotoRect ? [hitokotoRect] : []);
        })
        .catch(error => {
          console.error('Error fetching weather:', error);
          const weatherText = document.getElementById('weather-text');
          weatherText.textContent = '晴 25°C'; // 默认内容
          document.getElementById('weather-component').style.visibility = 'visible';
          const hitokotoRect = getRoundedRectInfo('random-component');
          adjustRoundedRectPositionById('weather-component', 'weather-text', hitokotoRect ? [hitokotoRect] : []);
        });
    }

    // 初始加载
    loadWeather();

    // 点击天气控件弹出城市选择弹窗
    document.getElementById('weather-component').onclick = function () {
      document.getElementById('city-modal').style.display = 'flex';
      document.getElementById('city-select').value = getWeatherCity();
    };
    // 关闭弹窗
    document.getElementById('city-modal-close').onclick = function () {
      document.getElementById('city-modal').style.display = 'none';
    };
    // 点击遮罩关闭
    document.getElementById('city-modal').onclick = function (e) {
      if (e.target === this) this.style.display = 'none';
    };
    // 保存城市
    document.getElementById('city-save-btn').onclick = function () {
      const city = document.getElementById('city-select').value;
      setWeatherCity(city);
      document.getElementById('city-modal').style.display = 'none';
      loadWeather();
    };

    // 拉伸时两个都自适应且动态避让
    const resizeObserver = new ResizeObserver(() => {
      // 先天气，后避让一言
      adjustRoundedRectPositionById('weather-component', 'weather-text', []);
      const weatherRect = getRoundedRectInfo('weather-component');
      adjustRoundedRectPositionById('random-component', 'hitokoto', weatherRect ? [weatherRect] : []);
    });
    resizeObserver.observe(document.getElementById('windowBox'));

    // 折叠菜单功能
    function handleNavCollapse() {
      const navBtns = document.querySelector('.nav-btns');
      const navBtnsArray = Array.from(navBtns.children);
      const windowBox = document.getElementById('windowBox');
      const minNavWidth = 600;

      // 检查是否已存在折叠菜单弹窗
      let collapseModal = document.getElementById('collapse-modal');
      if (!collapseModal) {
        collapseModal = document.createElement('div');
        collapseModal.id = 'collapse-modal';
        collapseModal.style.display = 'none';
        collapseModal.innerHTML = `
          <div class="collapse-modal-mask" style="
            position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;
            background:rgba(0,0,0,0.18);display:flex;align-items:center;justify-content:center;">
            <div class="collapse-modal-content" style="
              background:rgba(255,255,255,0.55);
              backdrop-filter:blur(18px);
              border-radius:24px;
              box-shadow:0 4px 24px rgba(0,0,0,0.10);
              padding:36px 32px 28px 32px;
              min-width:220px;display:flex;flex-direction:column;align-items:center;position:relative;">
              <button id="collapse-modal-close" style="
                position:absolute;top:18px;right:22px;font-size:28px;background:none;border:none;
                color:#888;cursor:pointer;transition:color 0.2s;">×</button>
              <div style="font-size:22px;font-weight:bold;color:#222;margin-bottom:18px;letter-spacing:2px;">
                功能菜单
              </div>
              <div id="collapse-modal-list" style="width:100%;display:flex;flex-direction:column;gap:12px;"></div>
            </div>
          </div>
        `;
        document.body.appendChild(collapseModal);

        // 关闭弹窗
        collapseModal.querySelector('#collapse-modal-close').onclick = function () {
          collapseModal.style.display = 'none';
        };
        // 点击遮罩关闭
        collapseModal.querySelector('.collapse-modal-mask').onclick = function (e) {
          if (e.target === this) collapseModal.style.display = 'none';
        };
      }

      // 汉堡按钮
      let collapseBtn = document.getElementById('collapse-toggle');
      if (!collapseBtn) {
        collapseBtn = document.createElement('button');
        collapseBtn.id = 'collapse-toggle';
        collapseBtn.style = 'width:44px;height:44px;border-radius:12px;background:rgba(255,255,255,0.7);border:none;cursor:pointer;font-size:24px;margin-right:10px;';
        collapseBtn.textContent = '☰';
        navBtns.parentNode.insertBefore(collapseBtn, navBtns);
        collapseBtn.onclick = function () {
          // 填充菜单项
          const list = collapseModal.querySelector('#collapse-modal-list');
          list.innerHTML = '';
          navBtnsArray.forEach((btn, idx) => {
            const item = document.createElement('button');
            item.className = 'nav-btn';
            item.style = 'width:180px;height:44px;border-radius:12px;background:rgba(255,255,255,0.85);border:none;cursor:pointer;font-size:20px;color:#333;margin:0 auto;';
            item.textContent = btn.textContent;
            item.onclick = function () {
              btn.click();
              collapseModal.style.display = 'none';
            };
            list.appendChild(item);
          });
          collapseModal.style.display = 'flex';
        };
      }

      if (windowBox.offsetWidth < minNavWidth) {
        collapseBtn.style.display = '';
        navBtns.style.display = 'none';
      } else {
        collapseBtn.style.display = 'none';
        navBtns.style.display = 'flex';
        collapseModal.style.display = 'none';
      }
    }

    // 初始化和监听窗口变化
    window.addEventListener('resize', handleNavCollapse);
    document.addEventListener('DOMContentLoaded', handleNavCollapse);
    const resizeObserverNav = new ResizeObserver(handleNavCollapse);
    resizeObserverNav.observe(document.getElementById('windowBox'));

    // 城市选择相关
    const cityModal = document.getElementById('city-modal');
    const citySelect = document.getElementById('city-select');
    const citySaveBtn = document.getElementById('city-save-btn');

    // 打开城市选择弹窗
    function openCityModal() {
      cityModal.style.display = 'flex';
    }

    // 关闭城市选择弹窗
    function closeCityModal() {
      cityModal.style.display = 'none';
    }

    // 保存选择的城市并刷新天气
    function saveSelectedCity() {
      const selectedCity = citySelect.value;
      setWeatherCity(selectedCity); // 保存到本地
      loadWeather();                // 刷新天气控件
      closeCityModal();
    }

    // 绑定事件
    document.getElementById('city-modal-close').onclick = closeCityModal;
    citySaveBtn.onclick = saveSelectedCity;

    // 菜单显示/隐藏控制
    const menuIds = ['menu-game', 'menu-dashboard', 'menu-message', 'menu-account'];
    function closeAllMenus() {
      menuIds.forEach(id => document.getElementById(id).style.display = 'none');
    }
    document.querySelectorAll('.nav-btn').forEach((btn, idx) => {
      btn.onclick = function () {
        closeAllMenus();
        if (idx === 0) return; // 首页，关闭所有菜单
        if (idx === 1) document.getElementById('menu-game').style.display = 'block';
        if (idx === 2) document.getElementById('menu-dashboard').style.display = 'block';
        if (idx === 3) document.getElementById('menu-message').style.display = 'block';
        if (idx === 4) document.getElementById('menu-account').style.display = 'block';
      };
    });
    // 菜单内关闭按钮
    document.querySelectorAll('.menu-close').forEach(btn => {
      btn.onclick = closeAllMenus;
    });

    // 游戏搜索功能
    document.getElementById('game-search').oninput = function () {
      const kw = this.value.trim();
      document.querySelectorAll('#game-list .game-item').forEach(item => {
        const name = item.querySelector('.game-name').textContent;
        item.style.display = name.includes(kw) ? '' : 'none';
      });
    };

    // 仪表盘设备信息与折线图（仅演示，需引入Chart.js或自绘）
    document.getElementById('device-os').textContent = navigator.userAgent;
    // 简单CPU等数据模拟
    function drawLineChart(canvasId, label, color) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      ctx.clearRect(0, 0, 320, 80);
      ctx.strokeStyle = color;
      ctx.beginPath();
      for (let i = 0; i < 32; i++) {
        const y = 60 - Math.random() * 50;
        ctx.lineTo(10 + i * 9, y);
      }
      ctx.stroke();
    }
    setInterval(() => {
      drawLineChart('chart-cpu', 'CPU', '#4e8cff');
      drawLineChart('chart-gpu', 'GPU', '#6ad1ff');
      drawLineChart('chart-mem', '内存', '#ffb84e');
    }, 1500);

    // 消息功能（本地演示，局域网需WebSocket等）
    document.querySelectorAll('.contact').forEach(c => {
      c.onclick = function () {
        document.querySelectorAll('.contact').forEach(x => x.classList.remove('active'));
        this.classList.add('active');
        document.querySelector('.chat-history').textContent = '';
      }
    });
    document.querySelector('.chat-send').onclick = function () {
      const input = document.querySelector('.chat-input');
      if (input.value.trim()) {
        const history = document.querySelector('.chat-history');
        history.innerHTML += `<div style="text-align:right;color:#4e8cff;">我: ${input.value}</div>`;
        input.value = '';
        history.scrollTop = history.scrollHeight;
      }
    };

    // 账户头像与昵称
    document.getElementById('avatar-upload').onchange = function (e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (ev) {
          document.getElementById('avatar-preview').src = ev.target.result;
          localStorage.setItem('user_avatar', ev.target.result);
        };
        reader.readAsDataURL(file);
      }
    };

    // 账户保存
    document.getElementById('account-save').onclick = function () {
      const name = document.getElementById('account-name').value;
      localStorage.setItem('user_name', name);
      showNotification({ title: '保存成功', message: '账户信息已保存' });
      showCreatorInfo();
    };

    function showCreatorInfo() {
      let creator = document.querySelector('.creator');
      if (!creator) {
        creator = document.createElement('div');
        creator.className = 'creator';
        document.getElementById('windowBox').appendChild(creator);
      }
      const avatar = localStorage.getItem('user_avatar') || '默认头像.png';
      const name = localStorage.getItem('user_name') || '未命名';
      creator.innerHTML = `<img src="${avatar}"><span>${name}</span>`;
      // 不再需要动态调整 right
    }
    showCreatorInfo();

    // 获取真实数据的函数（请根据实际接口替换实现）
    async function fetchRealStats() {
      // 示例：假设有本地API /api/stats 返回 {cpu: 3200, gpu: 1200, mem: 56}
      // const res = await fetch('/api/stats');
      // return await res.json();

      // 没有真实接口时，仍用模拟数据
      return {
        cpu: Math.round(Math.random() * 2000 + 2000), // 2000~4000 MHz
        gpu: Math.round(Math.random() * 800 + 800),   // 800~1600 MHz
        mem: Math.round(Math.random() * 60 + 30)      // 30~90 %
      };
    }

    function drawLineChart(canvasId, label, color, value, min, max, unit, freqId) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      ctx.clearRect(0, 0, 320, 80);

      // 绘制Y轴
      ctx.strokeStyle = "#bbb";
      ctx.beginPath();
      ctx.moveTo(30, 10);
      ctx.lineTo(30, 70);
      ctx.stroke();

      // 绘制X轴
      ctx.beginPath();
      ctx.moveTo(30, 70);
      ctx.lineTo(310, 70);
      ctx.stroke();

      // Y轴刻度
      ctx.fillStyle = "#888";
      ctx.font = "12px Arial";
      ctx.fillText(max + unit, 2, 18);
      ctx.fillText(min + unit, 2, 72);

      // 绘制折线
      ctx.strokeStyle = color;
      ctx.beginPath();
      for (let i = 0; i < 32; i++) {
        // 模拟数据
        let v = Math.random() * (max - min) + min;
        let y = 70 - ((v - min) / (max - min)) * 60;
        let x = 30 + i * 9;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.stroke();

      // 当前值显示
      if (freqId) {
        document.getElementById(freqId).textContent = value + unit;
      }
    }

    // 每5秒获取一次真实数据并绘图
    setInterval(async () => {
      const stats = await fetchRealStats();
      drawLineChart('chart-cpu', 'CPU', '#4e8cff', stats.cpu, 2000, 4000, ' MHz', 'cpu-freq');
      drawLineChart('chart-gpu', 'GPU', '#6ad1ff', stats.gpu, 800, 1600, ' MHz', 'gpu-freq');
      drawLineChart('chart-mem', '内存', '#ffb84e', stats.mem, 0, 100, '%', 'mem-usage');
    }, 5000);

    // 页面加载时先画一次
    (async () => {
      const stats = await fetchRealStats();
      drawLineChart('chart-cpu', 'CPU', '#4e8cff', stats.cpu, 2000, 4000, ' MHz', 'cpu-freq');
      drawLineChart('chart-gpu', 'GPU', '#6ad1ff', stats.gpu, 800, 1600, ' MHz', 'gpu-freq');
      drawLineChart('chart-mem', '内存', '#ffb84e', stats.mem, 0, 100, '%', 'mem-usage');
    })();

    // ==== 超级盒子窗口拖动、分屏吸附，且保持比例缩放 ====
    (function () {
      const box = document.getElementById('windowBox');
      let isDragging = false, dragOffsetX = 0, dragOffsetY = 0;
      let dragStartW = 0, dragStartH = 0;
      let dragStartL = 0, dragStartT = 0;
      let prevTransition = '';
      const minWidth = 400, minHeight = 250;
      const aspectRatio = 900 / 510;

      // 分屏吸附提示
      let snapHint = null;
      function showSnapHint(type) {
        if (!snapHint) {
          snapHint = document.createElement('div');
          snapHint.className = 'snap-hint';
          document.body.appendChild(snapHint);
        }
        snapHint.className = 'snap-hint ' + type;
      }
      function hideSnapHint() {
        if (snapHint) {
          snapHint.remove();
          snapHint = null;
        }
      }
      function getSnapType(e) {
        const margin = 40; // 原为20，改为40，吸附更容易
        const w = window.innerWidth, h = window.innerHeight;
        const nearLeft = e.clientX < margin;
        const nearRight = e.clientX > w - margin;
        const nearTop = e.clientY < margin;
        const nearBottom = e.clientY > h - margin;

        if (nearLeft && nearTop) return "topleft";
        if (nearRight && nearTop) return "topright";
        if (nearLeft && nearBottom) return "bottomleft";
        if (nearRight && nearBottom) return "bottomright";
        if (nearLeft) return "left";
        if (nearRight) return "right";
        if (nearTop) return "top";
        return "";
      }

      // 鼠标按下拖动
      box.addEventListener('mousedown', function (e) {
        // 排除拉伸手柄、菜单、按钮等
        if (
          e.target.classList.contains('resize-handle') ||
          e.target.classList.contains('close-btn') ||
          e.target.classList.contains('nav-btn') ||
          e.target.classList.contains('start-btn') ||
          e.target.closest('.hamburger-menu')
        ) return;

        isDragging = true;
        dragOffsetX = e.clientX - box.offsetLeft;
        dragOffsetY = e.clientY - box.offsetTop;
        dragStartW = box.offsetWidth;
        dragStartH = box.offsetHeight;
        dragStartL = box.offsetLeft;
        dragStartT = box.offsetTop;
        prevTransition = box.style.transition;
        box.style.transition = 'none';
        box.style.position = 'absolute';

        function onMove(ev) {
          if (!isDragging) return;
          let newL = ev.clientX - dragOffsetX;
          let newT = ev.clientY - dragOffsetY;
          // 限制不超出视口
          newL = Math.max(0, Math.min(newL, window.innerWidth - box.offsetWidth));
          newT = Math.max(0, Math.min(newT, window.innerHeight - box.offsetHeight));
          box.style.left = newL + 'px';
          box.style.top = newT + 'px';

          // 分屏吸附提示
          const snapType = getSnapType(ev);
          if (snapType) showSnapHint(snapType);
          else hideSnapHint();

          // 实时更新任务栏避让
          updateTaskbarVisibility();
        }

        function onUp(ev) {
          if (!isDragging) return;
          const snapType = getSnapType(ev);

          // 计算分屏区域的宽高
          function getSnapRect(type) {
            const winW = window.innerWidth, winH = window.innerHeight;
            let area = { left: 0, top: 0, width: winW, height: winH };
            if (type === "left") {
              area.width = winW / 2;
            } else if (type === "right") {
              area.left = winW / 2;
              area.width = winW / 2;
            } else if (type === "top") {
              // 最大化
              area = { left: 0, top: 0, width: winW, height: winH };
            } else if (type === "topleft") {
              area.width = winW / 2;
              area.height = winH / 2;
            } else if (type === "topright") {
              area.left = winW / 2;
              area.width = winW / 2;
              area.height = winH / 2;
            } else if (type === "bottomleft") {
              area.top = winH / 2;
              area.width = winW / 2;
              area.height = winH / 2;
            } else if (type === "bottomright") {
              area.left = winW / 2;
              area.top = winH / 2;
              area.width = winW / 2;
              area.height = winH / 2;
            }
            return area;
          }

          if (snapType) {
            const aspect = 900 / 510;
            const minWidth = 400, minHeight = 250;
            const area = getSnapRect(snapType);

            // 计算在分屏区域内最大且不超出区域的宽高，且保持比例
            let w = area.width, h = area.height;
            if (w / h > aspect) {
              // 区域太宽，按高度算
              h = Math.max(minHeight, Math.min(h, area.height));
              w = h * aspect;
            } else {
              // 区域太高，按宽度算
              w = Math.max(minWidth, Math.min(w, area.width));
              h = w / aspect;
            }
            // 居中
            const left = area.left + (area.width - w) / 2;
            const top = area.top + (area.height - h) / 2;

            box.style.left = left + "px";
            box.style.top = top + "px";
            box.style.width = w + "px";
            box.style.height = h + "px";
          }
          hideSnapHint();
          isDragging = false;
          box.style.transition = prevTransition;
          document.removeEventListener('mousemove', onMove);
          document.removeEventListener('mouseup', onUp);

          // 拉伸结束后重新调整两个圆角矩形的位置和大小，确保内容适配
          adjustRoundedRectPositionById('weather-component', 'weather-text', []);
          const weatherRect = getRoundedRectInfo('weather-component');
          adjustRoundedRectPositionById('random-component', 'hitokoto', weatherRect ? [weatherRect] : []);
        }

        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
      });
    }

    )();
    // 通用窗口拖动与分屏吸附（支持保持宽高比）
    function enableWindowDragAndSnap(winEl, aspectRatio = 400 / 340, minWidth = 240, minHeight = 120) {
      let isDragging = false, dragOffsetX = 0, dragOffsetY = 0;
      let dragStartW = 0, dragStartH = 0;
      let dragStartL = 0, dragStartT = 0;
      let prevTransition = '';
      let snapHint = null;

      function showSnapHint(type) {
        if (!snapHint) {
          snapHint = document.createElement('div');
          snapHint.className = 'snap-hint';
          document.body.appendChild(snapHint);
        }
        snapHint.className = 'snap-hint ' + type;
      }
      function hideSnapHint() {
        if (snapHint) {
          snapHint.remove();
          snapHint = null;
        }
      }
      function getSnapType(e) {
        const margin = 40;
        const w = window.innerWidth, h = window.innerHeight;
        const nearLeft = e.clientX < margin;
        const nearRight = e.clientX > w - margin;
        const nearTop = e.clientY < margin;
        const nearBottom = e.clientY > h - margin;

        if (nearLeft && nearTop) return "topleft";
        if (nearRight && nearTop) return "topright";
        if (nearLeft && nearBottom) return "bottomleft";
        if (nearRight && nearBottom) return "bottomright";
        if (nearLeft) return "left";
        if (nearRight) return "right";
        if (nearTop) return "top";
        return "";
      }

      // 只允许在标题栏拖动
      const titleBar = winEl.querySelector('.title-bar');
      if (!titleBar) return;

      titleBar.addEventListener('mousedown', function (e) {
        // 排除按钮
        if (
          e.target.classList.contains('mac-btn') ||
          e.target.closest('.mac-btns')
        ) return;

        isDragging = true;
        dragOffsetX = e.clientX - winEl.offsetLeft;
        dragOffsetY = e.clientY - winEl.offsetTop;
        dragStartW = winEl.offsetWidth;
        dragStartH = winEl.offsetHeight;
        dragStartL = winEl.offsetLeft;
        dragStartT = winEl.offsetTop;
        prevTransition = winEl.style.transition;
        winEl.style.transition = 'none';
        winEl.style.position = 'absolute';

        function onMove(ev) {
          if (!isDragging) return;
          let newL = ev.clientX - dragOffsetX;
          let newT = ev.clientY - dragOffsetY;
          // 限制不超出视口
          newL = Math.max(0, Math.min(newL, window.innerWidth - winEl.offsetWidth));
          newT = Math.max(0, Math.min(newT, window.innerHeight - winEl.offsetHeight));
          winEl.style.left = newL + 'px';
          winEl.style.top = newT + 'px';

          // 分屏吸附提示
          const snapType = getSnapType(ev);
          if (snapType) showSnapHint(snapType);
          else hideSnapHint();

          updateTaskbarVisibility();
        }

        function onUp(ev) {
          if (!isDragging) return;
          const snapType = getSnapType(ev);

          function getSnapRect(type) {
            const winW = window.innerWidth, winH = window.innerHeight;
            let area = { left: 0, top: 0, width: winW, height: winH };
            if (type === "left") {
              area.width = winW / 2;
            } else if (type === "right") {
              area.left = winW / 2;
              area.width = winW / 2;
            } else if (type === "top") {
              area = { left: 0, top: 0, width: winW, height: winH };
            } else if (type === "topleft") {
              area.width = winW / 2;
              area.height = winH / 2;
            } else if (type === "topright") {
              area.left = winW / 2;
              area.width = winW / 2;
              area.height = winH / 2;
            } else if (type === "bottomleft") {
              area.top = winH / 2;
              area.width = winW / 2;
              area.height = winH / 2;
            } else if (type === "bottomright") {
              area.left = winW / 2;
              area.top = winH / 2;
              area.width = winW / 2;
              area.height = winH / 2;
            }
            return area;
          }

          if (snapType) {
            let w = getSnapRect(snapType).width, h = getSnapRect(snapType).height;
            let area = getSnapRect(snapType);
            // 保持比例
            if (w / h > aspectRatio) {
              h = Math.max(minHeight, Math.min(h, area.height));
              w = h * aspectRatio;
            } else {
              w = Math.max(minWidth, Math.min(w, area.width));
              h = w / aspectRatio;
            }
            // 居中
            const left = area.left + (area.width - w) / 2;
            const top = area.top + (area.height - h) / 2;
            winEl.style.left = left + "px";
            winEl.style.top = top + "px";
            winEl.style.width = w + "px";
            winEl.style.height = h + "px";
          }
          hideSnapHint();
          isDragging = false;
          winEl.style.transition = prevTransition;
          document.removeEventListener('mousemove', onMove);
          document.removeEventListener('mouseup', onUp);

          updateTaskbarVisibility();
        }

        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
      });
    }

    // 启用 Mac窗口的拖动与分屏吸附
    enableWindowDragAndSnap(document.getElementById('macWindow'), 16 / 10, 240, 120);
    // 启用 Flyme互联窗口的拖动与分屏吸附
    // 比例为 16 / 10，最小宽高为 240 / 135
    enableWindowDragAndSnap(document.getElementById('flyme-linkpc'), 16 / 10, 240, 135);
    // 启用 Fanbook窗口的拖动与分屏吸附
    enableWindowDragAndSnap(document.getElementById('fanbook'), 16 / 10, 400, 250);


    const introVideo = document.getElementById('intro-video');
    const mainContent = document.getElementById('main-content');
    const skipBtn = document.getElementById('skip-btn');
    if (introVideo && mainContent && skipBtn) {
      function showMain() {
        introVideo.style.opacity = 0;
        skipBtn.style.opacity = 0;
        setTimeout(() => {
          introVideo.style.display = 'none';
          skipBtn.style.display = 'none';
          mainContent.style.display = '';
          // 任务栏先隐藏再显示，触发动画
          const taskbar = document.getElementById('taskbar');
          if (taskbar) {
            taskbar.classList.add('taskbar-hidden');
            setTimeout(() => {
              taskbar.classList.remove('taskbar-hidden');
            }, 480);
          }
          // === 绑定Mac窗口演示按钮事件 ===
          let count = 0;
          document.getElementById('helloBtn').onclick = function () {
            showNotification({ title: '你好', message: '欢迎使用可交互窗口！' });
          };
          document.getElementById('incBtn').onclick = function () {
            count++;
            document.getElementById('counter').textContent = count;
          };
          document.getElementById('alertBtn').onclick = function () {
            showNotification({ title: '演示', message: '这是一个弹窗按钮的演示。' });
          };
        }, 800);
      }
      introVideo.onended = showMain;
      skipBtn.onclick = showMain;
      introVideo.onerror = showMain;
      introVideo.addEventListener('click', showMain);
      mainContent.style.display = 'none';
    }

    // 动态壁纸
    const videoList = [
      'VF/kvvideo.mp4',
      'VF/qvniang.mp4',
      'VF/vertin_reverse_1999.mp4',
      'VF/xn-qvniang.mp4',
      //'VF/37.mp4',
      'VF/ATL-01.mp4',
      'VF/chill.mp4',
      'VF/furina.mp4',
      'VF/miku-x.mp4'
    ];
    document.getElementById('video-wallpaper').src = videoList[Math.floor(Math.random() * videoList.length)];

    // 日期
    function getDayOfWeekStr(date) {
      const days = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
      return days[date.getDay()];
    }
    function getAmPmStr(date) {
      const h = date.getHours();
      return h < 12 ? '上午' : '下午';
    }
    function updateDateInfo() {
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, '0');
      const d = String(now.getDate()).padStart(2, '0');
      const weekStr = getDayOfWeekStr(now);
      const ampmStr = getAmPmStr(now);
      document.getElementById('date-main').textContent = `${y}-${m}-${d}`;
      document.getElementById('date-sub').textContent = `（${weekStr}）${ampmStr}`;
    }
    updateDateInfo();
    setInterval(updateDateInfo, 600000);

    let topZIndex = 3000;

    // 激活窗口并前置
    function activateWindow(win) {
      topZIndex++;
      win.style.zIndex = topZIndex;
    }

    // Alt+Tab 快捷键切换窗口
    document.addEventListener('keydown', function (e) {
      if (e.altKey && e.key === 'Tab') {
        e.preventDefault();
        // 获取所有已打开且未最小化的窗口
        let openWins = windows.filter(w => w.isOpen && !w.isMinimized && !w.el.classList.contains('hidden'));
        if (openWins.length > 1) {
          // 按 zIndex 降序排列
          openWins.sort((a, b) => (parseInt(b.el.style.zIndex) || 0) - (parseInt(a.el.style.zIndex) || 0));
          // 找到当前最顶层窗口
          let idx = 0;
          if (document.activeElement) {
            idx = openWins.findIndex(w => w.el === document.activeElement.closest('.window, .window-container'));
          }
          let next = openWins[(idx + 1) % openWins.length];
          activateWindow(next.el);
          // 让窗口获得焦点
          next.el.focus && next.el.focus();
        }
      }
    });

    // 任务栏窗口区
    const taskbarCenter = document.querySelector('.taskbar-center');
    function updateTaskbarWindows() {
      const taskbar = document.getElementById('taskbar');
      if (!taskbar) return;
      // 清空原有窗口按钮
      let center = taskbar.querySelector('.taskbar-center');
      if (!center) {
        center = document.createElement('div');
        center.className = 'taskbar-center';
        taskbar.insertBefore(center, taskbar.children[1]);
      }
      center.innerHTML = '';
      windows.forEach(win => {
        if (win.isOpen) {
          const btn = document.createElement('div');
          btn.className = 'taskbar-window';
          // 仅显示图标
          const img = document.createElement('img');
          img.src = win.icon;
          img.alt = win.title;
          img.style.width = '24px';
          img.style.height = '24px';
          btn.appendChild(img);
          // 点击任务栏图标，自动前置并激活
          btn.onclick = () => {
            if (win.id === 'windowBox') {
              if (box.style.display === 'none' || box.classList.contains('hidden') || win.isMinimized) {
                box.style.display = '';
                box.classList.remove('hidden');
                win.isMinimized = false;
                win.isOpen = true;
                activateWindow(box);
              } else {
                box.style.display = 'none';
                box.classList.add('hidden');
                win.isMinimized = true;
              }
            } else {
              if (!win.isMinimized && !win.el.classList.contains('hidden')) {
                win.el.classList.add('hidden');
                win.isMinimized = true;
              } else {
                win.el.classList.remove('hidden');
                win.isMinimized = false;
                win.isOpen = true;
                activateWindow(win.el);
              }
            }
            activateWindow(win.el); // 新增：点击任务栏自动前置
            updateTaskbarWindows();
            updateTaskbarVisibility();
          };
          center.appendChild(btn);
          win.taskbarBtn = btn;
        } else {
          win.taskbarBtn = null;
        }
      });
    }

    // 窗口对象数组
    const windows = [
      {
        id: 'macWindow',
        el: document.getElementById('macWindow'),
        icon: './PIC/Mac.png',
        title: 'Mac窗口',
        isOpen: false,
        isMinimized: false,
        isMaximized: false,
        lastPosition: null,
        taskbarBtn: null
      },
      {
        id: 'flyme-linkpc',
        el: document.getElementById('flyme-linkpc'),
        icon: './PIC/flymelink.svg',
        title: 'Flyme 互联',
        isOpen: false,
        isMinimized: false,
        isMaximized: false,
        lastPosition: null,
        taskbarBtn: null
      },
      {
        id: 'windowBox',
        el: document.getElementById('windowBox'),
        icon: './PIC/windowBox.svg',
        title: '超级盒子',
        isOpen: false,
        isMinimized: false,
        isMaximized: false,
        lastPosition: null,
        taskbarBtn: null
      },
      {
        id: 'sudokuBox',
        el: document.getElementById('sudokuBox'),
        icon: './PIC/Sudoku.png',
        title: '数独游戏',
        isOpen: false,
        isMinimized: false,
        isMaximized: false,
        lastPosition: null,
        taskbarBtn: null
      },
      {
        id: 'fanbook',
        el: document.getElementById('fanbook'),
        icon: './PIC/fanbook.png',
        title: 'Fanbook',
        isOpen: false,
        isMinimized: false,
        isMaximized: false,
        lastPosition: null,
        taskbarBtn: null
      }
    ];

    // 新增：点击窗口自动前置
    windows.forEach(win => {
      // 支持 windowBox、sudokuBox、fanbook 这类 window-container
      win.el.addEventListener('mousedown', function (e) {
        // 排除按钮/拉伸手柄/菜单
        if (
          e.target.classList.contains('mac-btn') ||
          e.target.classList.contains('resize-handle') ||
          e.target.classList.contains('close-btn') ||
          e.target.classList.contains('nav-btn') ||
          e.target.classList.contains('start-btn') ||
          e.target.closest('.hamburger-menu')
        ) return;
        activateWindow(win.el);
      });
    });

    // ========== 所有 window-container 支持触摸拖动（仅标题栏可拖动，内容可交互） ==========
    ['windowBox', 'sudokuBox', 'fanbook', 'macWindow', 'flyme-linkpc'].forEach(function (id) {
      const box = document.getElementById(id);
      if (!box) return;
      let minWidth = 400, minHeight = 250;
      // 针对不同窗口自适应最小宽高和比例
      if (id === 'macWindow') { minWidth = 240; minHeight = 120; }
      if (id === 'flyme-linkpc') { minWidth = 240; minHeight = 135; }
      if (id === 'fanbook') { minWidth = 400; minHeight = 250; }
      if (id === 'windowBox') { minWidth = 400; minHeight = 250; }
      if (id === 'sudokuBox') { minWidth = 400; minHeight = 250; }

      function getClient(e) {
        if (e.touches && e.touches.length) {
          return { x: e.touches[0].clientX, y: e.touches[0].clientY };
        }
        return { x: e.clientX, y: e.clientY };
      }

      // 拉伸手柄支持触摸
      box.querySelectorAll('.resize-handle').forEach(handle => {
        function startResize(e) {
          e.preventDefault && e.preventDefault();
          let dir = this.className.split(' ')[1];
          const rect = box.getBoundingClientRect();
          const { x, y } = getClient(e);
          let startX = x, startY = y, startW = rect.width, startH = rect.height, startL = box.offsetLeft, startT = box.offsetTop;
          box.style.position = 'absolute';
          function onMove(ev) {
            const { x, y } = getClient(ev);
            let dx = x - startX;
            let dy = y - startY;
            let newW = startW, newH = startH, newL = startL, newT = startT;
            if (dir === 'e') newW = Math.max(minWidth, startW + dx);
            if (dir === 'w') { newW = Math.max(minWidth, startW - dx); newL = startL + dx; }
            if (dir === 's') newH = Math.max(minHeight, startH + dy);
            if (dir === 'n') { newH = Math.max(minHeight, startH - dy); newT = startT + dy; }
            if (dir === 'se') { newW = Math.max(minWidth, startW + dx); newH = Math.max(minHeight, startH + dy); }
            if (dir === 'sw') { newW = Math.max(minWidth, startW - dx); newL = startL + dx; newH = Math.max(minHeight, startH + dy); }
            if (dir === 'ne') { newW = Math.max(minWidth, startW + dx); newH = Math.max(minHeight, startH - dy); newT = startT + dy; }
            if (dir === 'nw') { newW = Math.max(minWidth, startW - dx); newL = startL + dx; newH = Math.max(minHeight, startH - dy); newT = startT + dy; }
            box.style.width = newW + 'px';
            box.style.height = newH + 'px';
            box.style.left = newL + 'px';
            box.style.top = newT + 'px';
            ev.preventDefault && ev.preventDefault();
          }
          function onUp() {
            document.removeEventListener('mousemove', onMove);
            document.removeEventListener('mouseup', onUp);
            document.removeEventListener('touchmove', onMove);
            document.removeEventListener('touchend', onUp);
          }
          document.addEventListener('mousemove', onMove);
          document.addEventListener('mouseup', onUp);
          document.addEventListener('touchmove', onMove, { passive: false });
          document.addEventListener('touchend', onUp);
        }
        handle.addEventListener('mousedown', startResize);
        handle.addEventListener('touchstart', startResize, { passive: false });
      });

      // 只允许在标题栏拖动
      let dragHandle = box.querySelector('.title-bar') || box.querySelector('.title');
      if (!dragHandle) return;

      dragHandle.addEventListener('mousedown', startDrag);
      dragHandle.addEventListener('touchstart', startDrag, { passive: false });

      function startDrag(e) {
        // 排除按钮
        if (
          e.target.classList.contains('mac-btn') ||
          e.target.classList.contains('close-btn') ||
          e.target.classList.contains('nav-btn') ||
          e.target.classList.contains('start-btn') ||
          (e.target.closest && e.target.closest('.mac-btns'))
        ) return;
        let isDragging = true;
        const { x, y } = getClient(e);
        let dragOffsetX = x - box.offsetLeft;
        let dragOffsetY = y - box.offsetTop;
        let prevTransition = box.style.transition;
        box.style.transition = 'none';
        box.style.position = 'absolute';
        function onMove(ev) {
          const { x, y } = getClient(ev);
          if (!isDragging) return;
          let newL = x - dragOffsetX;
          let newT = y - dragOffsetY;
          newL = Math.max(0, Math.min(newL, window.innerWidth - box.offsetWidth));
          newT = Math.max(0, Math.min(newT, window.innerHeight - box.offsetHeight));
          box.style.left = newL + 'px';
          box.style.top = newT + 'px';
          ev.preventDefault && ev.preventDefault();
        }
        function onUp() {
          isDragging = false;
          box.style.transition = prevTransition;
          document.removeEventListener('mousemove', onMove);
          document.removeEventListener('mouseup', onUp);
          document.removeEventListener('touchmove', onMove);
          document.removeEventListener('touchend', onUp);
        }
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
        document.addEventListener('touchmove', onMove, { passive: false });
        document.addEventListener('touchend', onUp);
        e.preventDefault && e.preventDefault();
      }
    });

    // 修复 sudokuBox 关闭按钮失效
    document.querySelector('#sudokuBox .close-btn').onclick = function () {
      closeWindow('sudokuBox');
      const win = windows.find(w => w.id === 'sudokuBox');
      if (win) {
        win.isOpen = false;
        win.isMinimized = false;
        updateTaskbarWindows();
        updateTaskbarVisibility();
      }
    };

    // Fanbook窗口关闭按钮事件
    document.querySelector('#fanbook .close-btn').onclick = function () {
      closeWindow('fanbook');
      const win = windows.find(w => w.id === 'fanbook');
      if (win) {
        win.isOpen = false;
        win.isMinimized = false;
        updateTaskbarWindows();
        updateTaskbarVisibility();
      }
    };

    // 打开窗口
    function openWindow(id) {
      const win = windows.find(w => w.id === id);
      if (!win) return;
      // 分别设置每个窗口的默认尺寸
      if (id === 'windowBox') {
        win.el.style.display = '';
        win.el.style.width = '400px';
        win.el.style.height = '250px';
        win.el.classList.remove('maximized');
        win.isMaximized = false;
      } else if (id === 'sudokuBox') {
        win.el.style.display = '';
        win.el.style.width = '400px';
        win.el.style.height = '348px';
        win.el.classList.remove('maximized');
        win.isMaximized = false;
      } else if (id === 'fanbook') {
        win.el.style.display = '';
        win.el.style.width = '566px';
        win.el.style.height = '410px';
        win.el.classList.remove('maximized');
        win.isMaximized = false;
      }
      win.el.classList.remove('hidden');
      win.isOpen = true;
      win.isMinimized = false;
      activateWindow(win.el);
      updateTaskbarWindows();
      updateTaskbarVisibility();
    }

    // 最小化窗口
    function minimizeWindow(id) {
      const win = windows.find(w => w.id === id);
      if (!win) return;
      win.el.classList.add('hidden');
      win.isMinimized = true;
      updateTaskbarWindows();
      updateTaskbarVisibility();
    }

    // 关闭窗口
    function closeWindow(id) {
      const win = windows.find(w => w.id === id);
      if (!win) return;
      if (id === 'windowBox' || id === 'sudokuBox' || id === 'fanbook') {
        win.el.style.display = 'none';
      }
      win.el.classList.add('hidden');
      win.isOpen = false;
      win.isMinimized = false;
      updateTaskbarWindows();
      updateTaskbarVisibility();
    }

    // 判断任意活动窗口是否接触任务栏
    function anyWindowTouchTaskbar() {
      const taskbarHeight = 56;
      // 1. 先判断普通窗口
      let hit = windows.some(win => {
        if (!win.isOpen || win.isMinimized || win.el.classList.contains('hidden')) return false;
        if (win.el.classList.contains('maximized')) return true;
        const rect = win.el.getBoundingClientRect();
        return (rect.bottom >= window.innerHeight - taskbarHeight - 1);
      });
      // 2. 再判断超级盒子 windowBox
      const box = document.getElementById('windowBox');
      if (box && box.style.display !== 'none') {
        const rect = box.getBoundingClientRect();
        if (rect.bottom >= window.innerHeight - taskbarHeight - 1) hit = true;
      }
      return hit;
    }

    // 统一任务栏避让
    function setTaskbarHidden(hidden) {
      const taskbar = document.getElementById('taskbar');
      if (hidden) taskbar.classList.add('taskbar-hidden');
      else taskbar.classList.remove('taskbar-hidden');
    }
    function updateTaskbarVisibility() {
      if (anyWindowTouchTaskbar()) {
        setTaskbarHidden(true);
      } else {
        setTaskbarHidden(false);
      }
    }

    // 桌面快捷方式/启动台点击
    document.querySelectorAll('.desktop-shortcut').forEach(el => {
      el.onclick = function () {
        openWindow(el.getAttribute('data-app'));
      };
    });

    // 启动台应用点击
    function renderLaunchpad(page = 0) {
      // 新增快捷键指南应用
      const APPS = [
        { icon: './PIC/Mac.png', name: 'Mac窗口', app: 'macWindow' },
        { icon: './PIC/flymelink.svg', name: 'Flyme 互联', app: 'flyme-linkpc' },
        { icon: './PIC/windowBox.svg', name: '超级盒子', app: 'windowBox' },
        { icon: './PIC/Sudoku.png', name: '数独游戏', app: 'sudokuBox' },
        { icon: './PIC/fanbook.png', name: 'Fanbook', app: 'fanbook' },
        { icon: 'https://img.icons8.com/fluency/48/keyboard.png', name: '操作指南', app: 'shortcutGuide' }
      ];
      const APPS_PER_PAGE = 9;
      const launchpad = document.getElementById('launchpad');
      const content = launchpad.querySelector('.launchpad-content');
      content.innerHTML = '';
      const start = page * APPS_PER_PAGE;
      const apps = APPS.slice(start, start + APPS_PER_PAGE);
      apps.forEach(app => {
        const el = document.createElement('div');
        el.className = 'launchpad-app';
        el.dataset.app = app.app;
        el.innerHTML = `<img src="${app.icon}" alt="${app.name}" /><span>${app.name}</span>`;
        el.onclick = function () {
          if (app.app === 'shortcutGuide') {
            // 打开快捷键指南弹窗
            showShortcutGuide(true);
            closeLaunchpad();
          } else {
            openWindow(app.app);
            closeLaunchpad();
          }
        };
        content.appendChild(el);
      });
      // 分页圆点
      let dots = launchpad.querySelector('.launchpad-pagination');
      if (!dots) {
        dots = document.createElement('div');
        dots.className = 'launchpad-pagination';
        launchpad.appendChild(dots);
      }
      dots.innerHTML = '';
      const pageCount = Math.ceil(APPS.length / APPS_PER_PAGE);
      for (let i = 0; i < pageCount; i++) {
        const dot = document.createElement('div');
        dot.className = 'launchpad-dot' + (i === page ? ' active' : '');
        dot.onclick = () => { renderLaunchpad(i); };
        dots.appendChild(dot);
      }
    }
    function openLaunchpad() {
      renderLaunchpad(0);
      const launchpad = document.getElementById('launchpad');
      launchpad.classList.add('active');
      launchpad.classList.remove('hidden');
      setTimeout(() => {
        launchpad.querySelectorAll('.launchpad-app').forEach((el, i) => {
          el.style.animationDelay = (i * 0.04) + 's';
          el.style.animationName = 'app-bounce-in';
        });
      }, 10);
      document.body.style.overflow = 'hidden';
    }
    function closeLaunchpad() {
      const launchpad = document.getElementById('launchpad');
      launchpad.classList.remove('active');
      setTimeout(() => {
        launchpad.classList.add('hidden');
        document.body.style.overflow = '';
      }, 380);
    }
    const starPlus = document.getElementById('starPlus');
    if (starPlus) {
      starPlus.onclick = openLaunchpad;
      const launchpad = document.getElementById('launchpad');
      launchpad.onclick = e => {
        if (e.target === launchpad) closeLaunchpad();
      };
      document.addEventListener('keydown', e => {
        if (launchpad.classList.contains('active') && e.key === 'Escape') closeLaunchpad();
      });
    }

    const menu = document.getElementById('menu');
    let hideTimeout = null;

    let contextTargetInput = null

    document.addEventListener('contextmenu', function (e) {
      contextTargetInput = null;
      if (e.target.id === 'launchpad-search-input') {
        contextTargetInput = e.target;
      }
      e.preventDefault();
      clearTimeout(hideTimeout);
      menu.style.top = e.clientY + 'px';
      menu.style.left = e.clientX + 'px';
      menu.classList.add('show');
    });

    document.addEventListener('click', function () {
      menu.classList.remove('show');
      // 动画结束后 pointer-events: none
      hideTimeout = setTimeout(() => {
        menu.style.pointerEvents = 'none';
      }, 200); // 与CSS动画时间一致
    });

    window.addEventListener('resize', function () {
      menu.classList.remove('show');
      hideTimeout = setTimeout(() => {
        menu.style.pointerEvents = 'none';
      }, 200);
    });

    // 防止菜单溢出屏幕
    menu.addEventListener('transitionend', function () {
      const rect = menu.getBoundingClientRect();
      if (rect.right > window.innerWidth) {
        menu.style.left = (window.innerWidth - rect.width - 10) + 'px';
      }
      if (rect.bottom > window.innerHeight) {
        menu.style.top = (window.innerHeight - rect.height - 10) + 'px';
      }
    });

    // 保证每次弹出都能点击
    menu.addEventListener('transitionstart', function (e) {
      if (menu.classList.contains('show')) {
        menu.style.pointerEvents = 'auto';
      }
    });

    // 窗口按钮事件绑定
    windows.forEach(win => {
      win.el.querySelector('.mac-btn.red').onclick = () => closeWindow(win.id);
      win.el.querySelector('.mac-btn.green').onclick = () => minimizeWindow(win.id);
      win.el.querySelector('.mac-btn.yellow').onclick = function () {
        const isBili = win.id === 'flyme-linkpc';
        let biliIframe = null;
        if (isBili) {
          biliIframe = win.el.querySelector('iframe');
          if (biliIframe) biliIframe.style.display = 'none';
        }
        if (!win.el.classList.contains('maximized')) {
          win.lastPosition = {
            left: win.el.offsetLeft,
            top: win.el.offsetTop,
            width: win.el.offsetWidth,
            height: win.el.offsetHeight
          };
          win.el.classList.add('maximized');
          win.el.style.left = "0";
          win.el.style.top = "0";
          win.el.style.width = "100vw";
          win.el.style.height = "100vh";
          win.isMaximized = true;
        } else {
          win.el.classList.remove('maximized');
          if (win.lastPosition) {
            win.el.style.left = win.lastPosition.left + 'px';
            win.el.style.top = win.lastPosition.top + 'px';
            win.el.style.width = win.lastPosition.width + 'px';
            win.el.style.height = win.lastPosition.height + 'px';
          }
          win.isMaximized = false;
        }
        // 延迟恢复iframe显示，等待窗口动画结束
        if (isBili && biliIframe) {
          setTimeout(() => {
            biliIframe.style.display = 'block';
          }, 220); // 动画时间略小于CSS的0.2s
        }
        updateTaskbarVisibility();
      };
    });

    function enableResizeHandles(winEl, aspectRatio = 16 / 10, minWidth = 240, minHeight = 120) {
      let startX, startY, startW, startH, startL, startT, dir;
      let resizing = false;
      let mask = null; // 遮罩层
      let iframes = Array.from(winEl.querySelectorAll('iframe'));
      let iframePrevDisplay = [];

      function onMouseMove(e) {
        if (!resizing) return;

        // 只在鼠标离开窗口整体（含内容区）一定距离时自动结束拉伸
        const edgeThreshold = 60; // px
        const rect = winEl.getBoundingClientRect();
        if (
          e.clientX < rect.left - edgeThreshold ||
          e.clientX > rect.right + edgeThreshold ||
          e.clientY < rect.top - edgeThreshold ||
          e.clientY > rect.bottom + edgeThreshold
        ) {
          onMouseUp();
          return;
        }

        let dx = e.clientX - startX;
        let dy = e.clientY - startY;
        let newW = startW, newH = startH, newL = startL, newT = startT;

        if (dir === 'e' || dir === 'w') {
          if (dir === 'e') newW = Math.max(minWidth, startW + dx);
          if (dir === 'w') {
            newW = Math.max(minWidth, startW - dx);
            newL = startL + dx;
          }
          newH = newW / aspectRatio;
          if (newH < minHeight) {
            newH = minHeight;
            newW = newH * aspectRatio;
          }
        } else if (dir === 'n' || dir === 's') {
          if (dir === 's') newH = Math.max(minHeight, startH + dy);
          if (dir === 'n') {
            newH = Math.max(minHeight, startH - dy);
            newT = startT + dy;
          }
          newW = newH * aspectRatio;
          if (newW < minWidth) {
            newW = minWidth;
            newH = newW / aspectRatio;
          }
        } else {
          let delta = 0;
          if (dir === 'se') delta = Math.max(dx, dy);
          if (dir === 'sw') delta = Math.max(-dx, dy);
          if (dir === 'ne') delta = Math.max(dx, -dy);
          if (dir === 'nw') delta = Math.max(-dx, -dy);

          if (dir === 'se' || dir === 'ne') {
            newW = Math.max(minWidth, startW + delta);
            newH = newW / aspectRatio;
          } else if (dir === 'sw' || dir === 'nw') {
            newW = Math.max(minWidth, startW - delta);
            newL = startL + delta;
            newH = newW / aspectRatio;
          }

          if (dir === 'ne' || dir === 'nw') {
            newT = startT - (newH - startH);
          }
          if (newH < minHeight) {
            newH = minHeight;
            newW = newH * aspectRatio;
          }
          if (newW < minWidth) {
            newW = minWidth;
            newH = newW / aspectRatio;
          }
        }

        winEl.style.width = newW + 'px';
        winEl.style.height = newH + 'px';
        winEl.style.left = newL + 'px';
        winEl.style.top = newT + 'px';
      }

      function onMouseUp() {
        if (!resizing) return;
        resizing = false;
        document.removeEventListener('mousemove', onMouseMove, true);
        document.removeEventListener('mouseup', onMouseUp, true);
        // 移除遮罩
        if (mask && mask.parentNode) mask.parentNode.removeChild(mask);
        mask = null;
        // 恢复iframe显示
        iframes.forEach((iframe, idx) => {
          iframe.style.display = iframePrevDisplay[idx] || '';
        });
      }

      winEl.querySelectorAll('.resize-handle').forEach(handle => {
        handle.addEventListener('mousedown', function (e) {
          e.preventDefault();
          e.stopPropagation();
          dir = this.className.split(' ')[1];
          const rect = winEl.getBoundingClientRect();
          startX = e.clientX;
          startY = e.clientY;
          startW = rect.width;
          startH = rect.height;
          startL = winEl.offsetLeft;
          startT = winEl.offsetTop;
          winEl.style.position = 'absolute';
          resizing = true;
          // 添加透明遮罩
          if (!mask) {
            mask = document.createElement('div');
            mask.style.position = 'absolute';
            mask.style.left = 0;
            mask.style.top = 0;
            mask.style.width = '100%';
            mask.style.height = '100%';
            mask.style.zIndex = 9999;
            mask.style.background = 'rgba(0,0,0,0)';
            mask.style.cursor = getComputedStyle(this).cursor || 'default';
            winEl.appendChild(mask);
          }
          // 隐藏iframe
          iframes = Array.from(winEl.querySelectorAll('iframe'));
          iframePrevDisplay = iframes.map(iframe => iframe.style.display);
          iframes.forEach(iframe => {
            iframe.style.display = 'none';
          });
          document.addEventListener('mousemove', onMouseMove, true);
          document.addEventListener('mouseup', onMouseUp, true);
        });
      });
    }

    // 统一拉伸，窗口调用
    enableResizeHandles(document.getElementById('windowBox'), 900 / 510, 400, 250);
    enableResizeHandles(document.getElementById('sudokuBox'), 16 / 9, 400, 250);
    enableResizeHandles(document.getElementById('fanbook'), 16 / 9, 566, 410);
    enableResizeHandles(document.getElementById('macWindow'), 16 / 9, 240, 240);
    enableResizeHandles(document.getElementById('flyme-linkpc'), 16 / 9, 240, 135);
  </script>
</body>

</html>
